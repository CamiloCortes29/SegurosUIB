{% extends "admin/layout.html" %}

{% block title %}Editar Lista: {{ list_name.replace('_', ' ')|title }}{% endblock %}

{% block head_extra %}
<style>
    .table-container {
        overflow-x: auto;
    }
    .styled-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1.5rem;
    }
    .styled-table th, .styled-table td {
        padding: 12px 15px;
        border: 1px solid #ddd;
        text-align: left;
    }
    .styled-table th {
        background-color: #f2f2f2;
    }
    .actions button {
        background: none; border: none; cursor: pointer; font-size: 1.1em;
        margin-right: 10px; transition: color 0.2s;
    }
    .btn-edit { color: #007bff; }
    .btn-edit:hover { color: #0056b3; }
    .btn-delete { color: #dc3545; }
    .btn-delete:hover { color: #a71d2a; }

    .form-add { display: flex; gap: 1rem; margin-bottom: 1.5rem; }
    .form-add input {
        padding: 10px; border: 1px solid #ced4da; border-radius: .25rem; font-size: 1rem;
    }
    .form-add .form-group { flex-grow: 1; }
    .form-add button {
        padding: 10px 15px; background-color: #28a745; color: white;
        border: none; border-radius: .25rem; cursor: pointer; transition: background-color 0.2s;
        align-self: flex-end;
    }
    .form-add button:hover { background-color: #218838; }

    #save-changes-btn {
        width: 100%; padding: 15px; background-color: #007bff; color: white;
        border: none; border-radius: .25rem; font-size: 1.2em; cursor: pointer;
        transition: background-color 0.2s;
    }
    #save-changes-btn:disabled { background-color: #6c757d; cursor: not-allowed; }

    .notification {
        padding: 1rem; margin-top: 1rem; border-radius: .25rem;
        display: none; text-align: center;
    }
    /* Estilos para lista simple */
    #item-list.simple .list-item {
        display: flex; justify-content: space-between; align-items: center;
        padding: .75rem 1.25rem; border-bottom: 1px solid #dee2e6;
    }
     #item-list.simple {
        background: #fff; border: 1px solid #dee2e6;
        border-radius: .25rem; margin-bottom: 1.5rem;
    }
    #item-list.simple .list-item:last-child { border-bottom: none; }
</style>
{% endblock %}

{% block content %}
<div class="content-header">
    <h1>Editando: {{ list_name.replace('_', ' ')|title }}</h1>
    <p>Añada, modifique o elimine elementos. No olvide guardar los cambios.</p>
</div>

<div class="card">
    {% if list_name == 'vendedores' %}
        <!-- Editor para Vendedores (Nombre y Comisión) -->
        <div class="form-add">
            <div class="form-group">
                <label for="new-item-name">Nombre del Vendedor</label>
                <input type="text" id="new-item-name" placeholder="Nombre completo">
            </div>
            <div class="form-group">
                <label for="new-item-comision">Comisión (%)</label>
                <input type="number" id="new-item-comision" placeholder="Ej: 15">
            </div>
            <button id="add-item-btn"><i class="fas fa-plus"></i> Añadir</button>
        </div>
        <div class="table-container">
            <table class="styled-table" id="item-list">
                <thead>
                    <tr>
                        <th>Nombre del Vendedor</th>
                        <th>Comisión (%)</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Filas generadas por JS -->
                </tbody>
            </table>
        </div>
    {% else %}
        <!-- Editor para Listas Simples -->
        <div class="form-add">
            <input type="text" id="new-item-input" placeholder="Añadir nuevo elemento y presionar Enter..." style="flex-grow:1;">
            <button id="add-item-btn"><i class="fas fa-plus"></i> Añadir</button>
        </div>
        <div id="item-list" class="simple">
            <!-- Items generados por JS -->
        </div>
    {% endif %}

    <button id="save-changes-btn">
        <i class="fas fa-save"></i> Guardar Cambios
    </button>
    <div id="notification" class="notification"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const listName = '{{ list_name }}';
    const isVendorList = listName === 'vendedores';
    let items = {{ items|tojson }};

    const itemListContainer = document.getElementById('item-list');
    const saveChangesBtn = document.getElementById('save-changes-btn');
    const notification = document.getElementById('notification');
    const addItemBtn = document.getElementById('add-item-btn');

    // Inputs para listas simples vs. vendedores
    const newItemInput = document.getElementById('new-item-input');
    const newVendorNameInput = document.getElementById('new-item-name');
    const newVendorComisionInput = document.getElementById('new-item-comision');

    function renderItems() {
        const target = isVendorList ? itemListContainer.querySelector('tbody') : itemListContainer;
        target.innerHTML = '';
        if (items.length === 0) {
            target.innerHTML = isVendorList ? '<tr><td colspan="3">No hay elementos en esta lista.</td></tr>' : '<p style="padding: 1rem 1.25rem;">No hay elementos.</p>';
            return;
        }

        items.forEach((item, index) => {
            if (isVendorList) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${escapeHTML(item.nombre)}</td>
                    <td>${escapeHTML(item.comision)}%</td>
                    <td class="actions">
                        <button class="btn-edit" data-index="${index}" title="Editar"><i class="fas fa-edit"></i></button>
                        <button class="btn-delete" data-index="${index}" title="Eliminar"><i class="fas fa-trash-alt"></i></button>
                    </td>
                `;
                target.appendChild(tr);
            } else {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <span class="item-text">${escapeHTML(item)}</span>
                    <div class="actions">
                        <button class="btn-edit" data-index="${index}" title="Editar"><i class="fas fa-edit"></i></button>
                        <button class="btn-delete" data-index="${index}" title="Eliminar"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `;
                target.appendChild(div);
            }
        });
    }

    function handleAddItem() {
        if (isVendorList) {
            const name = newVendorNameInput.value.trim();
            const comision = parseFloat(newVendorComisionInput.value);
            if (name && !isNaN(comision)) {
                if (items.some(v => v.nombre.toLowerCase() === name.toLowerCase())) {
                    showNotification('Ya existe un vendedor con ese nombre.', 'error');
                    return;
                }
                items.push({ nombre: name, comision: comision });
                newVendorNameInput.value = '';
                newVendorComisionInput.value = '';
                renderItems();
            } else {
                showNotification('Por favor, complete el nombre y la comisión.', 'error');
            }
        } else {
            const value = newItemInput.value.trim();
            if (value) {
                if (items.includes(value)) {
                    showNotification('El elemento ya existe.', 'error');
                    return;
                }
                items.push(value);
                newItemInput.value = '';
                renderItems();
            }
        }
    }

    function handleEditItem(index) {
        if (isVendorList) {
            const vendor = items[index];
            const newName = prompt('Editar nombre:', vendor.nombre);
            const newComisionStr = prompt('Editar comisión (%):', vendor.comision);
            const newComision = parseFloat(newComisionStr);

            if (newName && newName.trim() && !isNaN(newComision)) {
                const trimmedName = newName.trim();
                // Verificar si el nuevo nombre ya existe (y no es el item actual)
                if (items.some((v, i) => v.nombre.toLowerCase() === trimmedName.toLowerCase() && i !== index)) {
                    showNotification('Ya existe otro vendedor con ese nombre.', 'error');
                    return;
                }
                items[index] = { nombre: trimmedName, comision: newComision };
                renderItems();
            }
        } else {
            const current_value = items[index];
            const new_value = prompt('Editar elemento:', current_value);
            if (new_value && new_value.trim() !== '' && new_value.trim() !== current_value) {
                const trimmed_new_value = new_value.trim();
                if (items.includes(trimmed_new_value)) {
                    showNotification('El elemento ya existe.', 'error');
                    return;
                }
                items[index] = trimmed_new_value;
                renderItems();
            }
        }
    }

    function handleDeleteItem(index) {
        const itemName = isVendorList ? items[index].nombre : items[index];
        if (confirm(`¿Estás seguro de que quieres eliminar "${itemName}"?`)) {
            items.splice(index, 1);
            renderItems();
        }
    }

    // --- Funciones de guardado y notificación (sin cambios) ---
    async function handleSaveChanges() {
        saveChangesBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
        saveChangesBtn.disabled = true;
        try {
            const response = await fetch(`{{ url_for('admin.api_update_list', list_name=list_name) }}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(items),
            });
            const result = await response.json();
            if (response.ok && result.success) {
                showNotification('¡Lista guardada exitosamente!', 'success');
            } else {
                showNotification(`Error al guardar: ${result.message}`, 'error');
            }
        } catch (error) {
            showNotification(`Error de red: ${error.message}`, 'error');
        } finally {
            saveChangesBtn.innerHTML = '<i class="fas fa-save"></i> Guardar Cambios';
            saveChangesBtn.disabled = false;
        }
    }

    function showNotification(message, type) {
        notification.textContent = message;
        notification.className = `notification flash-${type}`;
        notification.style.display = 'block';
        notification.scrollIntoView({ behavior: 'smooth', block: 'end' });
        setTimeout(() => { notification.style.display = 'none'; }, 5000);
    }

    function escapeHTML(str) {
        const p = document.createElement('p');
        p.appendChild(document.createTextNode(String(str))); // Ensure str is a string
        return p.innerHTML;
    }

    // --- Event Listeners ---
    addItemBtn.addEventListener('click', handleAddItem);
    if(newItemInput) {
        newItemInput.addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); handleAddItem(); }});
    }
     if(newVendorNameInput) {
        newVendorNameInput.addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); handleAddItem(); }});
        newVendorComisionInput.addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); handleAddItem(); }});
    }

    saveChangesBtn.addEventListener('click', handleSaveChanges);

    itemListContainer.addEventListener('click', function(e) {
        const button = e.target.closest('button');
        if (!button) return;
        const index = parseInt(button.dataset.index, 10);
        if (button.classList.contains('btn-edit')) {
            handleEditItem(index);
        } else if (button.classList.contains('btn-delete')) {
            handleDeleteItem(index);
        }
    });

    renderItems();
});
</script>
{% endblock %}
