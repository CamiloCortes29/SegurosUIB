{% extends "admin/layout.html" %}

{% block title %}Editar Lista: {{ list_name.replace('_', ' ')|title }}{% endblock %}

{% block head_extra %}
<style>
    #item-list {
        background: #fff;
        border: 1px solid #dee2e6;
        border-radius: .25rem;
        margin-bottom: 1.5rem;
    }
    .list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: .75rem 1.25rem;
        border-bottom: 1px solid #dee2e6;
    }
    .list-item:last-child { border-bottom: none; }
    .item-text { flex-grow: 1; }
    .actions button {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.1em;
        margin-left: 10px;
        transition: color 0.2s;
    }
    .btn-edit { color: #007bff; }
    .btn-edit:hover { color: #0056b3; }
    .btn-delete { color: #dc3545; }
    .btn-delete:hover { color: #a71d2a; }

    .form-add { display: flex; margin-bottom: 1.5rem; }
    .form-add input {
        flex-grow: 1;
        padding: 10px;
        border: 1px solid #ced4da;
        border-radius: .25rem;
        font-size: 1rem;
    }
    .form-add button {
        padding: 10px 15px;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: .25rem;
        margin-left: 10px;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .form-add button:hover { background-color: #218838; }

    #save-changes-btn {
        width: 100%;
        padding: 15px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: .25rem;
        font-size: 1.2em;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    #save-changes-btn:hover { background-color: #0056b3; }
    #save-changes-btn:disabled { background-color: #6c757d; cursor: not-allowed; }

    .notification {
        padding: 1rem;
        margin-top: 1rem;
        border-radius: .25rem;
        display: none;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="content-header">
    <h1>Editando: {{ list_name.replace('_', ' ')|title }}</h1>
    <p>Añada, modifique o elimine elementos de la lista. No olvide guardar los cambios.</p>
</div>

<div class="card">
    <div class="form-add">
        <input type="text" id="new-item-input" placeholder="Añadir nuevo elemento y presionar Enter...">
        <button id="add-item-btn"><i class="fas fa-plus"></i> Añadir</button>
    </div>

    <div id="item-list">
        <!-- Los items se cargarán aquí con JS -->
    </div>

    <button id="save-changes-btn">
        <i class="fas fa-save"></i> Guardar Cambios
    </button>

    <div id="notification" class="notification"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const listName = '{{ list_name }}';
    let items = {{ items|tojson }};

    const itemList = document.getElementById('item-list');
    const newItemInput = document.getElementById('new-item-input');
    const addItemBtn = document.getElementById('add-item-btn');
    const saveChangesBtn = document.getElementById('save-changes-btn');
    const notification = document.getElementById('notification');

    function renderItems() {
        itemList.innerHTML = '';
        if (items.length === 0) {
            itemList.innerHTML = '<p style="padding: 1rem 1.25rem;">No hay elementos en esta lista.</p>';
            return;
        }
        items.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'list-item';
            div.innerHTML = `
                <span class="item-text">${escapeHTML(item)}</span>
                <div class="actions">
                    <button class="btn-edit" data-index="${index}" title="Editar"><i class="fas fa-edit"></i></button>
                    <button class="btn-delete" data-index="${index}" title="Eliminar"><i class="fas fa-trash-alt"></i></button>
                </div>
            `;
            itemList.appendChild(div);
        });
    }

    function handleAddItem() {
        const value = newItemInput.value.trim();
        if (value) {
            if (items.includes(value)) {
                showNotification('El elemento ya existe en la lista.', 'error');
                return;
            }
            items.push(value);
            newItemInput.value = '';
            renderItems();
            showNotification('Elemento añadido temporalmente. No olvides guardar los cambios.', 'info');
        }
    }

    function handleEditItem(index) {
        const current_value = items[index];
        const new_value = prompt('Editar elemento:', current_value);
        if (new_value && new_value.trim() !== '' && new_value.trim() !== current_value) {
            const trimmed_new_value = new_value.trim();
            if (items.includes(trimmed_new_value)) {
                showNotification('El elemento ya existe en la lista.', 'error');
                return;
            }
            items[index] = trimmed_new_value;
            renderItems();
        }
    }

    function handleDeleteItem(index) {
        if (confirm(`¿Estás seguro de que quieres eliminar "${items[index]}"?`)) {
            items.splice(index, 1);
            renderItems();
        }
    }

    async function handleSaveChanges() {
        saveChangesBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
        saveChangesBtn.disabled = true;

        try {
            const response = await fetch(`{{ url_for('admin.api_update_list', list_name=list_name) }}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(items),
            });
            const result = await response.json();
            if (response.ok && result.success) {
                showNotification('¡Lista guardada exitosamente!', 'success');
            } else {
                showNotification(`Error al guardar: ${result.message}`, 'error');
            }
        } catch (error) {
            showNotification(`Error de red: ${error.message}`, 'error');
        } finally {
            saveChangesBtn.innerHTML = '<i class="fas fa-save"></i> Guardar Cambios';
            saveChangesBtn.disabled = false;
        }
    }

    function showNotification(message, type) {
        notification.textContent = message;
        notification.className = `notification flash-${type}`;
        notification.style.display = 'block';

        // Scroll into view if it's off-screen
        notification.scrollIntoView({ behavior: 'smooth', block: 'end' });

        setTimeout(() => {
            notification.style.display = 'none';
        }, 5000);
    }

    function escapeHTML(str) {
        const p = document.createElement('p');
        p.appendChild(document.createTextNode(str));
        return p.innerHTML;
    }

    // Event Listeners
    addItemBtn.addEventListener('click', handleAddItem);
    newItemInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault(); // Evitar que el formulario se envíe si estuviera dentro de un <form>
            handleAddItem();
        }
    });

    saveChangesBtn.addEventListener('click', handleSaveChanges);

    itemList.addEventListener('click', function(e) {
        const button = e.target.closest('button');
        if (!button) return;

        const index = parseInt(button.dataset.index, 10);
        if (button.classList.contains('btn-edit')) {
            handleEditItem(index);
        } else if (button.classList.contains('btn-delete')) {
            handleDeleteItem(index);
        }
    });

    // Initial render
    renderItems();
});
</script>
{% endblock %}
