<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Módulo de Prospectos - UIB</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='main_layout.css') }}">
    <style>
        .status-badge {
            padding: 0.35em 0.65em;
            font-size: .75em;
            font-weight: 700;
            line-height: 1;
            color: #fff;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: .25rem;
        }
        .status-activo { background-color: #0dcaf0; }
        .status-en-gestión { background-color: #6c757d; }
        .status-cotización { background-color: #fd7e14; }
        .status-pdte-respuesta { background-color: #ffc107; color: #000 !important; }
        .status-ganado { background-color: #198754; }
        .status-perdido { background-color: #dc3545; }
        .status-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); z-index: 1000; }
        .status-notification-box { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; padding: 40px; border-radius: 15px; text-align: center; z-index: 1001; }
        .status-notification-box #status-icon { font-size: 5rem; }
        .status-notification-box #status-message { font-size: 2rem; font-weight: 700; margin-top: 20px; }
    </style>
</head>
<body>

<div class="main-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
             <img src="{{ url_for('static', filename='UIBH_logo_WHITE2-300x78-1.png') }}" alt="UIB Logo">
        </div>
        <ul class="nav flex-column">
            <li class="nav-item"><a class="nav-link" href="{{ url_for('formulario_remision') }}"><i class="fas fa-file-alt fa-fw"></i> Nueva Remisión</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('control') }}"><i class="fas fa-cogs fa-fw"></i> Control</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('panel_cobros') }}"><i class="fas fa-hand-holding-usd fa-fw"></i> Cobros</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('visualizar_cartera') }}"><i class="fas fa-book fa-fw"></i> Cartera</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('visualizar_vencimientos') }}"><i class="fas fa-calendar-times fa-fw"></i> Vencimientos</a></li>
            <li class="nav-item"><a class="nav-link active" href="{{ url_for('prospectos_vista') }}"><i class="fas fa-users fa-fw"></i> Prospectos</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('siniestros_registrar') }}"><i class="fas fa-car-crash fa-fw"></i> Siniestros</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('recaudo') }}"><i class="fas fa-chart-line fa-fw"></i> Recaudos</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('visualizar_sarlaft') }}"><i class="fas fa-user-shield fa-fw"></i> SARLAFT</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('mostrar_formulario_crear_carpeta') }}"><i class="fas fa-folder-plus fa-fw"></i> Crear Carpeta</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('mostrar_formulario_carga_maestra') }}"><i class="fas fa-upload fa-fw"></i> Carga Maestra</a></li>
            <li class="nav-item mt-auto"><a class="nav-link" href="{{ url_for('admin.dashboard') }}"><i class="fas fa-tachometer-alt fa-fw"></i> Admin</a></li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="content">
        <header class="pb-3 mb-4 border-bottom d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h3"><i class="fas fa-users me-2"></i>Módulo de Prospectos</h1>
                <p class="text-muted">Gestión y seguimiento de oportunidades de negocio.</p>
            </div>
            <a href="{{ url_for('crear_prospecto') }}" class="btn btn-primary"><i class="fas fa-plus me-2"></i>Registrar Prospecto</a>
        </header>

        <!-- KPIs -->
        <div class="row g-4 mb-4">
            <div class="col-lg-4 col-md-6">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0 me-3"><span class="kpi-icon-circle bg-success-soft"><i class="fas fa-dollar-sign text-success"></i></span></div>
                            <div class="flex-grow-1">
                                <p class="text-muted mb-1">Recaudo del Mes (Ganado)</p>
                                <h4 class="mb-0">{{ "${:,.0f}".format(kpi_recaudo_mes) }}</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% for ramo in kpi_top_ramos %}
            <div class="col-lg-4 col-md-6">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0 me-3"><span class="kpi-icon-circle bg-warning-soft"><i class="fas fa-medal text-warning"></i></span></div>
                            <div class="flex-grow-1">
                                <p class="text-muted mb-1">Top Ramo: {{ ramo.Ramo }}</p>
                                <h4 class="mb-0">{{ "${:,.0f}".format(ramo['Comision $']) }}</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="card shadow-sm">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                 <h5 class="mb-0">Listado de Prospectos</h5>
                 <div class="d-flex" id="filter-form">
                    <input type="text" id="search_query" name="search_query" class="form-control me-2" placeholder="Buscar...">
                    <select class="form-select me-2" style="width: 180px;" id="filtro_estado">
                        <option value="">Estado: Todos</option>
                        {% for opt in opciones_estado %}
                        <option value="{{ opt }}">{{ opt }}</option>
                        {% endfor %}
                    </select>
                    <select class="form-select" style="width: 180px;" id="filtro_responsable_tecnico">
                        <option value="">Responsable: Todos</option>
                        {% for opt in opciones_responsable_tecnico %}
                        <option value="{{ opt }}">{{ opt }}</option>
                        {% endfor %}
                    </select>
                 </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="prospectos-table">
                        <thead class="table-light">
                             <tr>
                                <th>Cliente</th>
                                <th>Resp. Técnico</th>
                                <th>Ramo</th>
                                <th>Comisión Potencial</th>
                                <th>Estado</th>
                                <th class="text-center">Acciones</th>
                                <!-- Hidden columns for script functionality -->
                                <th class="d-none">Resp. Comercial</th>
                                <th class="d-none">Fecha Cotización</th>
                                <th class="d-none">Fecha Emisión</th>
                                <th class="d-none">Aseguradora</th>
                                <th class="d-none">¿Es TPP?</th>
                                <th class="d-none">Nombre TPP</th>
                                <th class="d-none">% Comisión TPP</th>
                                <th class="d-none">Valor Comisión TPP</th>
                                <th class="d-none">Prima</th>
                                <th class="d-none">Comisión %</th>
                                <th class="d-none">Observaciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if prospectos %}
                                {% for prospecto in prospectos %}
                                    <tr data-id="{{ prospecto.ID_PROSPECTO }}">
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="ms-2">
                                                    <h6 class="mb-0">{{ prospecto['Nombre Cliente'] }}</h6>
                                                    <small class="text-muted aseguradora-info">Aseguradora: {{ prospecto.Aseguradora }}</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>{{ prospecto['Responsable Tecnico'] }}</td>
                                        <td>{{ prospecto.Ramo }}</td>
                                        <td class="comision-valor currency">{{ prospecto['Comision $'] }}</td>
                                        <td class="estado-cell"><span class="status-badge status-{{ prospecto.Estado | lower | replace(' ', '-') }}">{{ prospecto.Estado }}</span></td>
                                        <td class="text-center actions-cell">
                                            <a href="{{ url_for('prospecto_editar', prospecto_id=prospecto.ID_PROSPECTO) }}" class="btn btn-sm btn-outline-secondary" title="Editar"><i class="fas fa-pencil-alt"></i></a>
                                            {% if prospecto.Estado not in ['Ganado', 'Perdido'] %}
                                            <button class="btn btn-sm btn-outline-success btn-ganado" title="Marcar como Ganado"><i class="fas fa-check"></i></button>
                                            <button class="btn btn-sm btn-outline-danger btn-perdido" title="Marcar como Perdido"><i class="fas fa-times"></i></button>
                                            {% endif %}
                                        </td>
                                        <!-- Hidden cells for script functionality -->
                                        <td class="d-none">{{ prospecto['Responsable Comercial'] }}</td>
                                        <td class="d-none">{{ prospecto['Fecha de Cotizacion'] }}</td>
                                        <td class="d-none">{{ prospecto['Fecha inicio poliza'] }}</td>
                                        <td class="d-none">{{ prospecto.Aseguradora }}</td>
                                        <td class="d-none es-tpp-cell">{{ prospecto.es_TPP }}</td>
                                        <td class="d-none">{{ prospecto.Nombre_TPP }}</td>
                                        <td class="d-none porc-comision-tpp-cell percentage">{{ prospecto.Porcentaje_comision_TPP }}</td>
                                        <td class="d-none valor-comision-tpp currency"></td>
                                        <td class="d-none prima-valor currency">{{ prospecto.Prima }}</td>
                                        <td class="d-none comision-porc-valor percentage">{{ prospecto['Comision %'] }}</td>
                                        <td class="d-none">{{ prospecto.Observaciones }}</td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr><td colspan="6" class="text-center py-4">No hay prospectos para mostrar.</td></tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <footer class="pt-3 mt-4 text-muted border-top">&copy; 2024 UIB Corredores de Seguros S.A.</footer>
    </div>
</div>
<canvas id="confetti-canvas" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1001;"></canvas>
<div id="status-overlay" class="status-overlay"></div>
<div id="status-notification-box" class="status-notification-box">
    <div id="status-icon"></div>
    <h2 id="status-message"></h2>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        function parseCurrency(value) {
            if (typeof value === 'number') return value;
            if (typeof value !== 'string') return 0;
            return parseFloat(value.replace(/\$|\./g, '').replace(',', '.')) || 0;
        }

        function formatCurrency(value) {
            const number = parseCurrency(value);
            if (isNaN(number)) return '';
            return number.toLocaleString('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }
        
        function formatPercentage(value) {
            const number = parseFloat(value);
            if (isNaN(number) || value === null || value === '' || value === 0) return '0.0%';
            return `${number.toFixed(1)}%`;
        }

        function setupRow(row) {
            // Format currency and percentage cells on load
            row.querySelectorAll('.currency').forEach(cell => {
                if (cell.textContent.trim() !== '') {
                    cell.textContent = formatCurrency(cell.textContent);
                }
            });
            row.querySelectorAll('.percentage').forEach(cell => {
                if (cell.textContent.trim() !== '') {
                    cell.textContent = formatPercentage(cell.textContent);
                }
            });

            // Calculate and display Valor Comisión TPP
            const esTpp = row.querySelector('.es-tpp-cell').textContent.trim().toLowerCase() === 'si';
            const valorTppCell = row.querySelector('.valor-comision-tpp');
            
            if (esTpp && valorTppCell) {
                const primaText = row.querySelector('.prima-valor').textContent;
                const comisionPorcText = row.querySelector('.comision-porc-valor').textContent;
                const porcTppText = row.querySelector('.porc-comision-tpp-cell').textContent;

                const prima = parseCurrency(primaText);
                const comisionPorc = parseFloat(comisionPorcText) / 100 || 0;
                const porcTpp = parseFloat(porcTppText) / 100 || 0;
                
                const comisionBruta = prima * comisionPorc;
                const valorTpp = comisionBruta * porcTpp;
                
                valorTppCell.textContent = formatCurrency(valorTpp);
            } else if (valorTppCell) {
                valorTppCell.textContent = formatCurrency(0);
            }

            // Handle action buttons
            const actionsCell = row.querySelector('.actions-cell');
            const estadoBadge = row.querySelector('.status-badge');
            if (!actionsCell || !estadoBadge) return;
            
            const estado = estadoBadge.textContent.trim();
            const prospectoId = row.dataset.id;

            if (estado === 'Ganado' || estado === 'Perdido') {
                const ganadoBtn = actionsCell.querySelector('.btn-ganado');
                const perdidoBtn = actionsCell.querySelector('.btn-perdido');
                if (ganadoBtn) ganadoBtn.remove();
                if (perdidoBtn) perdidoBtn.remove();
            }

            if (estado === 'Ganado' && !actionsCell.querySelector('.btn-radicar')) {
                const radicarBtn = document.createElement('a');
                const tomador = row.cells[0].querySelector('h6').textContent.trim();
                const ramo = row.cells[2].textContent.trim();
                const aseguradora = row.querySelector('.aseguradora-info').textContent.replace('Aseguradora:', '').trim();
                const prima_text = row.querySelector('.prima-valor').textContent;
                const prima_neta = parseCurrency(prima_text);

                const params = new URLSearchParams({
                    tomador: tomador,
                    ramo: ramo,
                    aseguradora: aseguradora,
                    prima_neta: prima_neta.toFixed(0),
                    poliza: `PROS-${prospectoId}`
                });
                
                radicarBtn.href = `{{ url_for('formulario_remision') }}?${params.toString()}`;
                radicarBtn.className = 'btn btn-sm btn-primary btn-radicar';
                radicarBtn.innerHTML = '<i class="fas fa-file-alt"></i> Radicar';
                radicarBtn.title = 'Radicar Remisión';
                
                actionsCell.appendChild(radicarBtn);
            }
        }

        const tableRows = document.querySelectorAll('#prospectos-table tbody tr');
        tableRows.forEach(setupRow);

        // Filter logic
        const filtroResponsable = document.getElementById('filtro_responsable_tecnico');
        const filtroEstado = document.getElementById('filtro_estado');
        const searchQuery = document.getElementById('search_query');

        function filterTable() {
            const respFiltro = filtroResponsable.value.toLowerCase();
            const estadoFiltro = filtroEstado.value.toLowerCase();
            const searchFiltro = searchQuery.value.toLowerCase();

            tableRows.forEach(row => {
                if(row.cells.length < 2) return; 
                const respTecnico = row.cells[1].textContent.toLowerCase();
                const estado = row.querySelector('.status-badge') ? row.querySelector('.status-badge').textContent.toLowerCase().trim() : '';
                const rowText = row.textContent.toLowerCase();

                const respMatch = !respFiltro || respTecnico.includes(respFiltro);
                const estadoMatch = !estadoFiltro || estado.includes(estadoFiltro);
                const searchMatch = !searchFiltro || rowText.includes(searchFiltro);

                row.style.display = (respMatch && estadoMatch && searchMatch) ? '' : 'none';
            });
        }
        
        filtroResponsable.addEventListener('change', filterTable);
        filtroEstado.addEventListener('change', filterTable);
        searchQuery.addEventListener('input', filterTable);

        // Status change logic
        document.getElementById('prospectos-table').addEventListener('click', function(event) {
            const target = event.target.closest('.btn-ganado, .btn-perdido');
            if (!target) return;

            const row = target.closest('tr');
            const prospectoId = row.dataset.id;
            const nuevoEstado = target.classList.contains('btn-ganado') ? 'Ganado' : 'Perdido';
            
            target.disabled = true;
            target.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            fetch("{{ url_for('actualizar_estado_prospecto') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prospecto_id: prospectoId, estado: nuevoEstado })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const estadoCell = row.querySelector('.estado-cell');
                    estadoCell.innerHTML = `<span class="status-badge status-${nuevoEstado.toLowerCase().replace(' ', '-')}">${nuevoEstado}</span>`;
                    
                    if (data.fecha_emision) {
                        const fechaEmisionCell = row.cells[8]; // Hidden cell
                        if(fechaEmisionCell) fechaEmisionCell.textContent = data.fecha_emision;
                    }
                    
                    setupRow(row); 
                    
                    if (nuevoEstado === 'Ganado') {
                        showStatusNotification('won');
                    } else {
                        showStatusNotification('lost');
                    }
                } else {
                    alert('Error: ' + data.message);
                    target.disabled = false;
                    target.innerHTML = nuevoEstado === 'Ganado' ? '<i class="fas fa-check"></i>' : '<i class="fas fa-times"></i>';
                }
            })
            .catch(error => {
                 console.error('Error:', error);
                 alert('Error de conexión. Intente de nuevo.');
                 target.disabled = false;
                 target.innerHTML = nuevoEstado === 'Ganado' ? '<i class="fas fa-check"></i>' : '<i class="fas fa-times"></i>';
            });
        });

        function showStatusNotification(type) {
            const overlay = document.getElementById('status-overlay');
            const box = document.getElementById('status-notification-box');
            const icon = document.getElementById('status-icon');
            const message = document.getElementById('status-message');

            if (type === 'won') {
                icon.innerHTML = '🏆';
                message.textContent = '¡Felicitaciones!';
                triggerConfettiRain();
            } else {
                icon.innerHTML = '🙁';
                message.textContent = 'Una lástima...';
            }

            overlay.style.display = 'block';
            box.style.display = 'block';

            setTimeout(() => {
                overlay.style.display = 'none';
                box.style.display = 'none';
            }, 3000);
        }

        function triggerConfettiRain() {
            const myCanvas = document.getElementById('confetti-canvas');
            const myConfetti = confetti.create(myCanvas, { resize: true });
            const duration = 2 * 1000;
            const animationEnd = Date.now() + duration;
            const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 1001 };

            function randomInRange(min, max) {
                return Math.random() * (max - min) + min;
            }

            const interval = setInterval(function() {
                const timeLeft = animationEnd - Date.now();
                if (timeLeft <= 0) {
                    return clearInterval(interval);
                }
                const particleCount = 50 * (timeLeft / duration);
                myConfetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } }));
                myConfetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } }));
            }, 250);
        }
    });
</script>
</body>
</html>