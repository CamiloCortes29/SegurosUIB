<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Cobro - {{ cobro.Tomador }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='main_layout.css') }}">
</head>
<body>

<div class="main-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
             <img src="{{ url_for('static', filename='UIBH_logo_WHITE2-300x78-1.png') }}" alt="UIB Logo">
        </div>
        <ul class="nav flex-column">
            <li class="nav-item"><a class="nav-link" href="{{ url_for('formulario_remision') }}"><i class="fas fa-file-alt fa-fw"></i> Nueva Remisión</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('control') }}"><i class="fas fa-cogs fa-fw"></i> Control</a></li>
            <li class="nav-item"><a class="nav-link active" href="{{ url_for('panel_cobros') }}"><i class="fas fa-hand-holding-usd fa-fw"></i> Cobros</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('visualizar_cartera') }}"><i class="fas fa-book fa-fw"></i> Cartera</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('visualizar_vencimientos') }}"><i class="fas fa-calendar-times fa-fw"></i> Vencimientos</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('prospectos_vista') }}"><i class="fas fa-users fa-fw"></i> Prospectos</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('siniestros_registrar') }}"><i class="fas fa-car-crash fa-fw"></i> Siniestros</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('recaudo') }}"><i class="fas fa-chart-line fa-fw"></i> Recaudos</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('visualizar_sarlaft') }}"><i class="fas fa-user-shield fa-fw"></i> SARLAFT</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('mostrar_formulario_crear_carpeta') }}"><i class="fas fa-folder-plus fa-fw"></i> Crear Carpeta</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('mostrar_formulario_carga_maestra') }}"><i class="fas fa-upload fa-fw"></i> Carga Maestra</a></li>
            <li class="nav-item mt-auto"><a class="nav-link" href="{{ url_for('admin.dashboard') }}"><i class="fas fa-tachometer-alt fa-fw"></i> Admin</a></li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="content">
        <header class="pb-3 mb-4 border-bottom d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h3"><i class="fas fa-edit me-2"></i>Editar Cobro</h1>
                <p class="text-muted">Genere la carta de cobro para el registro seleccionado.</p>
            </div>
            <a href="{{ url_for('panel_cobros') }}" class="btn btn-outline-secondary"><i class="fas fa-arrow-left"></i> Volver al Panel de Cobros</a>
        </header>

        <div class="card shadow-sm">
            <div class="card-header">
                <h5 class="mb-0">Detalles del Cobro</h5>
            </div>
            <div class="card-body">
                <p><strong>ID:</strong> {{ cobro.ID_COBRO }}</p>
                <p><strong>Tomador:</strong> {{ cobro.Tomador }}</p>
                <p><strong>Póliza No:</strong> {{ cobro.N_Poliza }}</p>
                <p><strong>Cuota:</strong> {{ cobro.N_Cuota }} de {{ cobro.Total_Cuotas }}</p>
                <p><strong>Vencimiento:</strong> {{ cobro.Fecha_Vencimiento_Cuota.strftime('%Y-%m-%d') if cobro.Fecha_Vencimiento_Cuota else '' }}</p>
                <hr>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#cartaModal">
                    <i class="fas fa-envelope me-2"></i> Generar Carta de Cobro
                </button>
            </div>
        </div>
        
        <footer class="pt-3 mt-4 text-muted border-top">&copy; 2024 UIB Corredores de Seguros S.A.</footer>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="cartaModal" tabindex="-1" aria-labelledby="cartaModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cartaModalLabel">Datos para la Carta</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="cartaForm">
            <div class="row">
                <div class="col-md-6 mb-3"><label for="sr_sra" class="form-label">Atn. Sr./Sra.:</label><input type="text" id="sr_sra" class="form-control" required></div>
                <div class="col-md-6 mb-3"><label for="correo" class="form-label">Correo:</label><input type="email" id="correo" class="form-control" required></div>
            </div>
            <div class="mb-3"><label for="ref_asunto" class="form-label">Asunto (Ref):</label><input type="text" id="ref_asunto" class="form-control" required></div>
            <div class="mb-3"><label for="descripcion" class="form-label">Descripción (para la tabla):</label><textarea id="descripcion" class="form-control" rows="2"></textarea></div>
            <div class="mb-3"><label for="garantias" class="form-label">Garantías Particulares:</label><textarea id="garantias" class="form-control" rows="3"></textarea></div>
            <div class="row">
                <div class="col-md-6 mb-3"><label for="fecha_inicio_cobro" class="form-label">Fecha Inicio del Periodo de Cobro:</label><input type="date" id="fecha_inicio_cobro" class="form-control" required></div>
                <div class="col-md-6 mb-3"><label for="fecha_fin_cobro" class="form-label">Fecha Fin del Periodo de Cobro:</label><input type="date" id="fecha_fin_cobro" class="form-control" required></div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3"><label for="fecha_de_pago" class="form-label">Fecha de pago:</label><input type="date" id="fecha_de_pago" class="form-control" required></div>
                <div class="col-md-6 mb-3"><label for="valor_a_pagar" class="form-label">Valor a Pagar:</label><input type="number" id="valor_a_pagar" class="form-control" step="0.01" required></div>
            </div>
            <div class="mb-3"><label for="link_de_pago" class="form-label">Link de Pago (Opcional):</label><input type="url" id="link_de_pago" class="form-control"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="submit" form="cartaForm" class="btn btn-primary">Crear Carta</button>
      </div>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const cobroData = {{ cobro | tojson }};
    const cartaModal = new bootstrap.Modal(document.getElementById('cartaModal'));
    const form = document.getElementById("cartaForm");

    document.getElementById('cartaModal').addEventListener('show.bs.modal', function () {
        document.getElementById('ref_asunto').value = `Cobro Póliza ${cobroData.N_Poliza} - ${cobroData.Tomador}`;
    });

    form.onsubmit = function(event) {
        event.preventDefault();
        
        const formData = {
            sr_sra: document.getElementById('sr_sra').value,
            correo: document.getElementById('correo').value,
            ref_asunto: document.getElementById('ref_asunto').value,
            descripcion: document.getElementById('descripcion').value,
            garantias: document.getElementById('garantias').value,
            fecha_inicio_cobro: document.getElementById('fecha_inicio_cobro').value,
            fecha_fin_cobro: document.getElementById('fecha_fin_cobro').value,
            fecha_de_pago: document.getElementById('fecha_de_pago').value,
            valor_a_pagar: parseFloat(document.getElementById('valor_a_pagar').value).toLocaleString('es-CO', {style: 'currency', currency: 'COP', minimumFractionDigits: 2}),
            link_de_pago: document.getElementById('link_de_pago').value,
        };

        const cartaHTML = `
        <!DOCTYPE html>
        <html lang="es">
        <head>
            <meta charset="UTF-8">
            <title>Carta de Cobro - ${cobroData.Tomador}</title>
            <style>
                body { font-family: Calibri, sans-serif; font-size: 11pt; }
                .header-table { width: 100%; border-collapse: collapse; }
                .header-table td { vertical-align: top; }
                .logo-cell { text-align: right; }
                .logo-cell p { margin: 0; font-size: 9pt; }
                .main-content { margin-top: 20px; }
                .policy-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
                .policy-table th, .policy-table td { border-bottom: 1px solid black; padding: 5px; text-align: left; }
                .policy-table th { font-weight: bold; }
                .footer { margin-top: 20px; }
                .copy-button { text-align: center; margin-top: 20px; padding-top: 10px; border-top: 1px solid #ccc; }
                @media print { .copy-button { display: none; } }
            </style>
        </head>
        <body>
            <table class="header-table">
                <tr>
                    <td>
                        <p>Señores</p>
                        <p><strong>${cobroData.Tomador}</strong></p>
                        <p>Atn. Sr./Sra. <strong>${formData.sr_sra}</strong></p>
                        <p>${formData.correo}</p>
                        <p>Ciudad</p>
                    </td>
                    <td class="logo-cell">
                        <p><strong>UIB Corredores de Seguros S.A.</strong></p>
                        <p>Cra.7 # 71-21 Of.601, Torre B</p>
                        <p>Bogotá D.C., Colombia</p>
                        <p>+57 (601) 326 7100</p>
                        <p>www.uibseguros.com.co</p>
                    </td>
                </tr>
            </table>
            <div class="main-content">
                <p>Bogotá D.C., ${new Date().toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
                <p>${cobroData.CONSECUTIVO_REMISION || ''}</p>
                <p><strong>Ref.: ${formData.ref_asunto}</strong></p>
                <hr>
                <p>Apreciados señores:</p>
                <p>Agradecemos la confianza depositada en <strong>UIB Corredores de Seguros S.A.</strong> y nos complace hacerles entrega del presente cobro, correspondiente a la póliza suscrita con <strong>${cobroData.Aseguradora}</strong>, cuya vigencia se extiende desde las 00:00 horas del <strong>${formData.fecha_inicio_cobro}</strong> hasta las 00:00 horas del <strong>${formData.fecha_fin_cobro}</strong>, según el siguiente detalle:</p>
                <table class="policy-table">
                    <thead>
                        <tr><th>Póliza No.</th><th>Descripción</th><th>Valor por pagar</th></tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>${cobroData.Ramo} No.${cobroData.N_Poliza}</td>
                            <td>${formData.descripcion}</td>
                            <td>${formData.valor_a_pagar}</td>
                        </tr>
                    </tbody>
                </table>
                <p><strong>GARANTÍAS PARTICULARES:</strong></p>
                <p>${formData.garantias}</p>
                <hr>
                <p>Adjuntamos el recibo de pago correspondiente, los cuales deberá ser cancelado a más tardar el día <strong>${formData.fecha_de_pago}</strong>. Una vez efectuado el pago, les agradecemos notificarlo al correo electrónico sbarrios@uiblatam.com.</p>
                <p>${formData.link_de_pago ? `<a href="${formData.link_de_pago}">${formData.link_de_pago}</a>` : ''}</p>
                <hr>
                <p>Finalmente, reiteramos que nuestro principal compromiso es ofrecer un servicio de excelencia y atención personalizada. Bajo esta filosofía y con el respaldo de nuestro equipo humano, UIB CORREDORES DE SEGUROS S.A. continúa brindando a sus clientes asesoría permanente, generando la confianza y tranquilidad necesarias para delegar en nuestra organización el manejo integral de sus programas de seguros.</p>
                <p>Cordialmente,</p>
            </div>
            <div class="copy-button">
                <button onclick="copiarContenido()">Copiar al Portapapeles</button>
            </div>
            <script>
                function copiarContenido() {
                    const body = document.body;
                    const range = document.createRange();
                    range.selectNode(body);
                    window.getSelection().removeAllRanges();
                    window.getSelection().addRange(range);
                    try {
                        document.execCommand('copy');
                        alert('¡Contenido copiado al portapapeles!');
                    } catch (err) {
                        alert('No se pudo copiar el contenido.');
                    }
                    window.getSelection().removeAllRanges();
                }
            <\/script>
        </body>
        </html>
        `;

        const newWindow = window.open();
        newWindow.document.write(cartaHTML);
        newWindow.document.close();
        
        cartaModal.hide();
    }
});
</script>
</body>
</html>