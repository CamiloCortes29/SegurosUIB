<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Remisión - UIB</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='main_layout.css') }}">
    <style>
        .form-control[readonly] { background-color: #e9ecef; opacity: 1; }
        .card-header h5 { color: var(--primary-dark); }
        .highlight-card { border-color: var(--primary-color); }
        .highlight-card .card-header { color: white; }
        .form-group-checkbox-display { display: flex; align-items: center; gap: 10px; }
        .form-group-checkbox-display input { flex-grow: 1; }
    </style>
</head>
<body>

<div class="main-container">
    <!-- Sidebar -->
    <div class="sidebar">
  <div class="sidebar">
        <div class="sidebar-header">
            <a href="{{ url_for('index') }}">
                <img src="{{ url_for('static', filename='UIBH_logo_WHITE2-300x78-1.png') }}" alt="UIB Logo">
            </a>
        </div>
        <ul class="nav flex-column">
            <li class="nav-item"><a class="nav-link active" href="{{ url_for('formulario_remision') }}"><i class="fas fa-file-alt fa-fw"></i> Nueva Remisión</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('control') }}"><i class="fas fa-cogs fa-fw"></i> Control de remisiones </a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('panel_cobros') }}"><i class="fas fa-hand-holding-usd fa-fw"></i> Cobros</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('visualizar_cartera') }}"><i class="fas fa-book fa-fw"></i> Cartera</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('visualizar_vencimientos') }}"><i class="fas fa-calendar-times fa-fw"></i> Vencimientos</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('prospectos_vista') }}"><i class="fas fa-users fa-fw"></i> Prospectos</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('siniestros_registrar') }}"><i class="fas fa-car-crash fa-fw"></i> Siniestros</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('recaudo') }}"><i class="fas fa-chart-line fa-fw"></i> Produccion</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('visualizar_sarlaft') }}"><i class="fas fa-user-shield fa-fw"></i> SARLAFT</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('mostrar_formulario_crear_carpeta') }}"><i class="fas fa-folder-plus fa-fw"></i> Crear Carpeta</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('mostrar_formulario_carga_maestra') }}"><i class="fas fa-upload fa-fw"></i> Carga Maestra</a></li>
            <li class="nav-item mt-auto"><a class="nav-link" href="{{ url_for('admin.dashboard') }}"><i class="fas fa-tachometer-alt fa-fw"></i> Admin</a></li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="content">
        <header class="pb-3 mb-4 border-bottom"><h1 class="h3"><i class="fas fa-edit me-2"></i>Editar Remisión</h1><p class="text-muted">Consecutivo: <strong>{{ datos.get('consecutivo', 'N/A') }}</strong></p></header>

        <form method="POST" action="{{ url_for('guardar_numero_remision') }}" id="editForm">
            <input type="hidden" name="consecutivo" value="{{ datos.get('consecutivo', '') }}">
            
            <div class="card shadow-sm mb-4 highlight-card"><div class="card-header"><h5 class="mb-0"><i class="fas fa-file-signature me-2"></i>Número de Remisión</h5></div><div class="card-body"><div class="row"><div class="col-md-6"><label for="numero_remision_manual" class="form-label">Número Remisión</label><input type="text" class="form-control" name="numero_remision_manual" id="numero_remision_manual" value="{{ datos.get('numero_remision_manual', '') }}" placeholder="Ingrese el número de remisión" required><div class="form-text">Este es el único campo que se puede modificar.</div></div></div></div></div>

            <div class="card shadow-sm mb-4"><div class="card-header"><h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Datos de la Remisión</h5></div><div class="card-body"><div class="row g-3">
                <div class="col-md-3"><label class="form-label">Consecutivo:</label><input type="text" class="form-control" value="{{ datos.consecutivo | default('', true) }}" readonly></div>
                <div class="col-md-3"><label class="form-label">Fecha de Registro:</label><input type="text" class="form-control" value="{{ datos.fecha_registro | default('', true) }}" readonly></div>
                <div class="col-md-3"><label class="form-label">Estado Actual:</label><input type="text" class="form-control" value="{{ datos.estado | default('', true) }}" readonly></div>
                <div class="col-md-3"><label class="form-label">Fecha Recepción:</label><input type="text" class="form-control" value="{{ datos.fecha_recepcion | default('', true) }}" readonly></div>
                <div class="col-12 mt-3">
                    <label class="form-label">Tipo de Remisión:</label>
                    <div class="d-flex flex-wrap gap-2">
                        {% if datos.get('renovacion') == 'si' %}<span class="badge fs-6 bg-success"><i class="fas fa-redo me-1"></i> Renovación</span>{% endif %}
                        {% if datos.get('negocio_nuevo') == 'si' %}<span class="badge fs-6 bg-info"><i class="fas fa-plus-circle me-1"></i> Negocio Nuevo</span>{% endif %}
                        {% if datos.get('renovable') == 'si' %}<span class="badge fs-6 bg-primary"><i class="fas fa-sync me-1"></i> Renovable</span>{% endif %}
                        {% if datos.get('modificacion') == 'si' %}<span class="badge fs-6 bg-warning text-dark"><i class="fas fa-edit me-1"></i> Modificación</span>{% endif %}
                        {% if datos.get('anexo') == 'si' %}<span class="badge fs-6 bg-secondary"><i class="fas fa-paperclip me-1"></i> Anexo</span>{% endif %}
                    </div>
                </div>
                <div class="col-md-3"><label class="form-label">Tomador:</label><input type="text" class="form-control" value="{{ datos.tomador | default('', true) }}" readonly></div>
                <div class="col-md-3"><label class="form-label">NIT/CC:</label><input type="text" class="form-control" value="{{ datos.nit | default('', true) }}" readonly></div>
                <div class="col-md-3"><label class="form-label">Aseguradora:</label><input type="text" class="form-control" value="{{ datos.aseguradora | default('', true) }}" readonly></div>
                <div class="col-md-3"><label class="form-label">Ramo:</label><input type="text" class="form-control" value="{{ datos.ramo | default('', true) }}" readonly></div>
                <div class="col-md-3"><label class="form-label">N° Póliza:</label><input type="text" class="form-control" value="{{ datos.poliza | default('', true) }}" readonly></div>
                <div class="col-md-3"><label class="form-label">Numero Anexo / Certificado:</label><input type="text" class="form-control" value="{{ datos.numero_anexo | default('', true) }}" readonly></div>
                <div class="col-md-3"><label class="form-label">Fecha Inicio Vigencia:</label><input type="text" class="form-control" value="{{ datos.fecha_inicio | default('', true) }}" readonly></div>
                <div class="col-md-3"><label class="form-label">Fecha Fin Vigencia:</label><input type="text" class="form-control" value="{{ datos.fecha_fin | default('', true) }}" readonly></div>
                <div class="col-md-3"><label class="form-label">Fecha Límite de Pago:</label><input type="text" class="form-control" value="{{ datos.fecha_limite_pago | default('', true) }}" readonly></div>
            </div></div></div>

            <div class="card shadow-sm mb-4"><div class="card-header"><h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Información de Venta y Comisiones</h5></div><div class="card-body"><div class="row g-3">
                <div class="col-md-3"><label class="form-label">Prima Neta:</label><input type="text" class="form-control" id="prima_neta_display" value="{{ datos.prima_neta | default('', true) }}" readonly></div>
                <div class="col-md-3"><label class="form-label">% Comisión:</label><input type="text" class="form-control" id="porcentaje_comision_valor_display" value="{{ datos.porcentaje_comision_valor | default('', true) }}" readonly></div>
                <div class="col-md-3"><label class="form-label">Comision$:</label><input type="text" class="form-control" id="comision_calculada" readonly></div>
                <div class="col-md-3"><label class="form-label">Vendedor:</label><input type="text" class="form-control" value="{{ datos.vendedor | default('', true) }}" readonly></div>
                <div class="col-md-3"><label class="form-label">% Participación Vendedor:</label><input type="text" class="form-control" id="porcentaje_vendedor_display" value="{{ datos.porcentaje_vendedor | default('', true) }}" readonly></div>
                <div class="col-md-3"><label class="form-label">ComisionTPP:</label><input type="text" class="form-control" id="comision_tpp" readonly></div>
                <div class="col-md-3"><label class="form-label">ComisionUIB:</label><input type="text" class="form-control" id="uib" readonly></div>
            </div></div></div>

            <div class="card shadow-sm mb-4"><div class="card-header"><h5 class="mb-0"><i class="fas fa-credit-card me-2"></i>Información del Pago</h5></div><div class="card-body"><div class="row g-3">
                <div class="col-md-4"><label class="form-label">Periodicidad de Pago:</label><input type="text" class="form-control" id="periodicidad_pago_display" value="{{ datos.periodicidad_pago | default('', true) }}" readonly></div>
                <div class="col-md-4"><label class="form-label">Forma de Pago:</label><input type="text" class="form-control" id="forma_pago_display" value="{{ datos.forma_pago | default('', true) }}" readonly></div>
                <div class="col-md-4" id="numero_cuotas_group" style="display: none;"><label class="form-label"># de Cuotas:</label><input type="text" class="form-control" id="numero_cuotas" value="{{ datos.numero_cuotas | default('', true) }}" readonly></div>
            </div></div></div>
            
            <div class="card shadow-sm mb-4"><div class="card-header"><h5 class="mb-0"><i class="far fa-file-alt me-2"></i>Observaciones</h5></div><div class="card-body"><div class="row g-3">
                <div class="col-12"><label class="form-label">Observaciones Generales:</label><textarea class="form-control" rows="3" readonly>{{ datos.observaciones | default('', true) }}</textarea></div>
                <div class="col-12"><label class="form-label">Riesgos Adicionales:</label><textarea class="form-control" rows="3" readonly>{{ datos.riesgos_adicionales | default('', true) }}</textarea></div>
            </div></div></div>

            <div class="d-flex justify-content-end mb-4">
                <a href="{{ url_for('control') }}" class="btn btn-secondary me-2"><i class="fas fa-arrow-left me-2"></i>Volver a Control</a>
                <button type="submit" class="btn btn-primary"><i class="fas fa-save me-2"></i>Guardar Número de Remisión</button>
            </div>
        </form>

        <footer class="pt-3 mt-4 text-muted border-top">&copy; 2024 UIB Corredores de Seguros S.A.</footer>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        function toggleCuotasField() {
            const periodicidad = "{{ datos.periodicidad_pago | default('', true) }}";
            const formaPago = "{{ datos.forma_pago | default('', true) }}";
            const cuotasGroup = document.getElementById('numero_cuotas_group');
            const formasPagoValidas = ['Fraccionado', 'Acuerdo de pago', 'Financiado'];
            if (periodicidad === 'Mensual' && formasPagoValidas.includes(formaPago)) {
                cuotasGroup.style.display = 'block';
            } else {
                cuotasGroup.style.display = 'none';
            }
        }
        function calcularComisiones() {
            const primaNeta = parseFloat("{{ datos.prima_neta | default('0', true) }}".replace(/\$|\./g, '')) || 0;
            const porcComision = parseFloat("{{ datos.porcentaje_comision_valor | default('0', true) }}".replace(',', '.')) || 0;
            const porcParticipacionVendedor = parseFloat("{{ datos.porcentaje_vendedor | default('0', true) }}".replace(',', '.')) || 0;
            const comisionCalculadaInput = document.getElementById('comision_calculada');
            const comisionTppInput = document.getElementById('comision_tpp');
            const participacionUibInput = document.getElementById('uib');
            const comisionCalculada = primaNeta * (porcComision / 100);
            comisionCalculadaInput.value = '$' + Math.round(comisionCalculada).toLocaleString('es-CO');
            comisionTppInput.value = '';
            participacionUibInput.value = '';
            if (porcParticipacionVendedor >= 100) {
                participacionUibInput.value = '$' + Math.round(comisionCalculada).toLocaleString('es-CO');
            } else if (porcParticipacionVendedor > 0) {
                const comisionTpp = comisionCalculada * (porcParticipacionVendedor / 100);
                comisionTppInput.value = '$' + Math.round(comisionTpp).toLocaleString('es-CO');
                const comisionUib = comisionCalculada - comisionTpp;
                participacionUibInput.value = '$' + Math.round(comisionUib).toLocaleString('es-CO');
            } else {
                participacionUibInput.value = '$' + Math.round(comisionCalculada).toLocaleString('es-CO');
            }
        }
        toggleCuotasField();
        calcularComisiones();
    });
</script>
</body>
</html>