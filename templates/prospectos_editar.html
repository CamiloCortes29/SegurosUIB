<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Prospecto - UIB</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='main_layout.css') }}">
</head>
<body>

<div class="main-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
             <img src="{{ url_for('static', filename='UIBH_logo_WHITE2-300x78-1.png') }}" alt="UIB Logo">
        </div>
        <ul class="nav flex-column">
            <li class="nav-item"><a class="nav-link active" href="{{ url_for('formulario_remision') }}"><i class="fas fa-file-alt fa-fw"></i> Nueva Remisión</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('control') }}"><i class="fas fa-cogs fa-fw"></i> Control de remisiones </a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('panel_cobros') }}"><i class="fas fa-hand-holding-usd fa-fw"></i> Cobros</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('visualizar_cartera') }}"><i class="fas fa-book fa-fw"></i> Cartera</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('visualizar_vencimientos') }}"><i class="fas fa-calendar-times fa-fw"></i> Vencimientos</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('prospectos_vista') }}"><i class="fas fa-users fa-fw"></i> Prospectos</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('siniestros_registrar') }}"><i class="fas fa-car-crash fa-fw"></i> Siniestros</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('recaudo') }}"><i class="fas fa-chart-line fa-fw"></i> Produccion</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('visualizar_sarlaft') }}"><i class="fas fa-user-shield fa-fw"></i> SARLAFT</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('mostrar_formulario_crear_carpeta') }}"><i class="fas fa-folder-plus fa-fw"></i> Crear Carpeta</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('mostrar_formulario_carga_maestra') }}"><i class="fas fa-upload fa-fw"></i> Carga Maestra</a></li>
            <li class="nav-item mt-auto"><a class="nav-link" href="{{ url_for('admin.dashboard') }}"><i class="fas fa-tachometer-alt fa-fw"></i> Admin</a></li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="content">
        <header class="pb-3 mb-4 border-bottom d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h3"><i class="fas fa-edit me-2"></i>Editar Prospecto</h1>
                <p class="text-muted">Modifique los datos del prospecto ID: <strong>{{ prospecto.ID_PROSPECTO }}</strong></p>
            </div>
             <a href="{{ url_for('prospectos_vista') }}" class="btn btn-outline-secondary"><i class="fas fa-arrow-left"></i> Volver a Prospectos</a>
        </header>

        <form action="{{ url_for('prospecto_guardar_edicion') }}" method="POST" id="prospecto-edit-form" class="card p-4">
            <input type="hidden" name="ID_PROSPECTO" value="{{ prospecto.ID_PROSPECTO }}">
            
            <fieldset class="mb-4">
                <legend class="h5 mb-3"><i class="fas fa-user-tie"></i> Información del Prospecto</legend>
                <div class="row">
                    <div class="col-md-12">
                        <div class="mb-3">
                            <label for="nombre_cliente" class="form-label">Nombre Cliente</label>
                            <input type="text" class="form-control" id="nombre_cliente" name="Nombre Cliente" value="{{ prospecto['Nombre Cliente'] }}" required>
                        </div>
                    </div>
                </div>
                 <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="responsable_tecnico" class="form-label">Responsable Técnico</label>
                            <select class="form-select" id="responsable_tecnico" name="Responsable Tecnico" required>
                                {% for opt in opciones_responsable_tecnico %}
                                <option value="{{ opt }}" {% if opt == prospecto['Responsable Tecnico'] %}selected{% endif %}>{{ opt }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                         <div class="mb-3">
                            <label for="responsable_comercial" class="form-label">Responsable Comercial</label>
                            <select class="form-select" id="responsable_comercial" name="Responsable Comercial" required>
                                {% for opt in opciones_responsable_comercial %}
                                <option value="{{ opt }}" {% if opt == prospecto['Responsable Comercial'] %}selected{% endif %}>{{ opt }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
            </fieldset>

            <fieldset class="mb-4">
                <legend class="h5 mb-3"><i class="fas fa-file-contract"></i> Detalles de la Cotización</legend>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="fecha_cotizacion" class="form-label">Fecha de Cotización</label>
                            <input type="date" class="form-control" id="fecha_cotizacion" name="Fecha de Cotizacion" value="{{ prospecto['Fecha de Cotizacion'] }}" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                         <div class="mb-3">
                            <label for="fecha_inicio_poliza" class="form-label">Fecha Emisión</label>
                            <input type="date" class="form-control" id="fecha_inicio_poliza" name="Fecha inicio poliza" value="{{ prospecto['Fecha inicio poliza'] }}">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                         <div class="mb-3">
                            <label for="ramo" class="form-label">Ramo</label>
                            <select class="form-select" id="ramo" name="Ramo">
                                <option value="">Seleccione...</option>
                                {% for opt in opciones_ramo %}
                                <option value="{{ opt }}" {% if opt == prospecto.Ramo %}selected{% endif %}>{{ opt }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                         <div class="mb-3">
                            <label for="aseguradora" class="form-label">Aseguradora</label>
                            <select class="form-select" id="aseguradora" name="Aseguradora">
                                <option value="">Seleccione...</option>
                                {% for opt in opciones_aseguradora %}
                                <option value="{{ opt }}" {% if opt == prospecto.Aseguradora %}selected{% endif %}>{{ opt }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                         <div class="mb-3">
                            <label for="prima" class="form-label">Prima</label>
                            <input type="text" class="form-control" id="prima" name="Prima" placeholder="$0" value="{{ prospecto.Prima | int }}" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                         <div class="mb-3">
                            <label for="comision_porcentaje" class="form-label">Comisión %</label>
                            <input type="number" class="form-control" id="comision_porcentaje" name="Comision %" step="0.01" value="{{ prospecto['Comision %'] }}" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                         <div class="mb-3">
                            <label for="comision_valor" class="form-label">Comisión $ (Calculado)</label>
                            <input type="text" class="form-control" id="comision_valor" name="Comision $" value="{{ prospecto['Comision $'] | int }}" readonly>
                        </div>
                    </div>
                </div>
            </fieldset>
            
            <fieldset class="mb-4">
                <legend class="h5 mb-3"><i class="fas fa-handshake"></i> TPP</legend>
                <div class="row">
                    <div class="col-md-12">
                        <div class="mb-3">
                            <label for="es_tpp" class="form-label">¿Es TPP?</label>
                            <select class="form-select" id="es_tpp" name="es_TPP">
                                <option value="no" {% if prospecto.es_TPP == 'no' %}selected{% endif %}>No</option>
                                <option value="si" {% if prospecto.es_TPP == 'si' %}selected{% endif %}>Sí</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div id="tpp-details" style="display: {% if prospecto.es_TPP == 'si' %}block{% else %}none{% endif %};">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="nombre_tpp" class="form-label">Nombre TPP</label>
                                <select class="form-select" id="nombre_tpp" name="Nombre_TPP">
                                    <option value="">Seleccione Vendedor...</option>
                                    {% for vendedor in opciones_vendedor %}
                                    <option value="{{ vendedor.nombre }}" data-comision="{{ vendedor.comision }}" {% if vendedor.nombre == prospecto.Nombre_TPP %}selected{% endif %}>{{ vendedor.nombre }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="porcentaje_comision_tpp" class="form-label">Porcentaje Comisión TPP</label>
                                <input type="number" class="form-control" id="porcentaje_comision_tpp" name="Porcentaje_comision_TPP" step="0.01" value="{{ prospecto.Porcentaje_comision_TPP }}" placeholder="0.0">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="valor_comision_tpp" class="form-label">Valor Comisión TPP (Calculado)</label>
                                <input type="text" class="form-control" id="valor_comision_tpp" name="Valor_Comision_TPP" readonly>
                            </div>
                        </div>
                    </div>
                </div>
            </fieldset>

            <fieldset class="mb-4">
                <legend class="h5 mb-3"><i class="fas fa-cogs"></i> Estado y Seguimiento</legend>
                 <div class="row">
                    <div class="col-md-12">
                        <div class="mb-3">
                            <label for="estado" class="form-label">Estado</label>
                            <select class="form-select" id="estado" name="Estado" required>
                                {% for opt in opciones_estado %}
                                <option value="{{ opt }}" {% if opt == prospecto.Estado %}selected{% endif %}>{{ opt }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                         <div class="mb-3">
                            <label for="observaciones" class="form-label">Observaciones</label>
                            <textarea class="form-control" id="observaciones" name="Observaciones" rows="3">{{ prospecto.Observaciones }}</textarea>
                        </div>
                    </div>
                </div>
            </fieldset>

            <div class="text-end">
                <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Guardar Cambios</button>
                <a href="{{ url_for('prospectos_vista') }}" class="btn btn-secondary">Cancelar</a>
            </div>
        </form>
        <footer class="pt-3 mt-4 text-muted border-top">&copy; 2024 UIB Corredores de Seguros S.A.</footer>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const primaInput = document.getElementById('prima');
    const comisionPorcentajeInput = document.getElementById('comision_porcentaje');
    const comisionValorInput = document.getElementById('comision_valor');
    const esTppSelect = document.getElementById('es_tpp');
    const tppDetails = document.getElementById('tpp-details');
    const porcentajeTppInput = document.getElementById('porcentaje_comision_tpp');
    const valorTppInput = document.getElementById('valor_comision_tpp');

    function formatIntegerCurrency(input) {
        let value = input.value.replace(/[^0-9]/g, '');
        if (value) {
            input.value = '$' + parseInt(value, 10).toLocaleString('es-CO');
        } else {
            input.value = '';
        }
    }

    function calcularComision() {
        const prima = parseFloat(primaInput.value.replace(/\$|\./g, '').replace(/,/g, '')) || 0;
        const porcentaje = parseFloat(comisionPorcentajeInput.value) || 0;
        let comisionCalculadaBruta = prima * (porcentaje / 100);
        let comisionFinal = comisionCalculadaBruta;

        if (esTppSelect.value === 'si') {
            const porcentajeTpp = parseFloat(porcentajeTppInput.value) || 0;
            const valorTpp = comisionCalculadaBruta * (porcentajeTpp / 100);
            valorTppInput.value = valorTpp.toLocaleString('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0, maximumFractionDigits: 0 });
            comisionFinal -= valorTpp;
        } else {
            valorTppInput.value = ''; // Limpiar si no es TPP
        }
        
        comisionValorInput.value = comisionFinal.toLocaleString('es-CO', {
            style: 'currency',
            currency: 'COP',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        });
    }

    // Formatear el valor inicial de la prima al cargar la página
    if(primaInput.value) {
        formatIntegerCurrency(primaInput);
    }

    // Event Listeners
    primaInput.addEventListener('input', () => {
        formatIntegerCurrency(primaInput);
        calcularComision();
    });
    comisionPorcentajeInput.addEventListener('input', calcularComision);
    esTppSelect.addEventListener('change', function() {
        tppDetails.style.display = this.value === 'si' ? 'block' : 'none';
         if (this.value !== 'si') {
            document.getElementById('nombre_tpp').value = '';
            porcentajeTppInput.value = '';
        }
        calcularComision();
    });
    porcentajeTppInput.addEventListener('input', calcularComision);

    document.getElementById('nombre_tpp').addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption) {
            const comision = selectedOption.dataset.comision;
            document.getElementById('porcentaje_comision_tpp').value = comision || '';
            // Disparamos el evento 'input' para que la función de cálculo principal se ejecute
            document.getElementById('porcentaje_comision_tpp').dispatchEvent(new Event('input'));
        }
    });
    
    // Calcular comisiones con los valores iniciales al cargar la página
    calcularComision();

    // Limpiar valores de moneda antes de enviar el formulario
    const form = document.getElementById('prospecto-edit-form');
    form.addEventListener('submit', function() {
        const primaValue = primaInput.value.replace(/\$|\./g, '').replace(/,/g, '');
        primaInput.value = primaValue;
    });
});
</script>
</body>
</html>