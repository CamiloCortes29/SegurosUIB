<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Carpeta - UIB</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='main_layout.css') }}">
</head>
<body>

<div class="main-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
             <img src="{{ url_for('static', filename='UIBH_logo_WHITE2-300x78-1.png') }}" alt="UIB Logo">
        </div>
        <ul class="nav flex-column">
            <li class="nav-item"><a class="nav-link active" href="{{ url_for('formulario_remision') }}"><i class="fas fa-file-alt fa-fw"></i> Nueva Remisión</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('control') }}"><i class="fas fa-cogs fa-fw"></i> Control de remisiones </a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('panel_cobros') }}"><i class="fas fa-hand-holding-usd fa-fw"></i> Cobros</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('visualizar_cartera') }}"><i class="fas fa-book fa-fw"></i> Cartera</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('visualizar_vencimientos') }}"><i class="fas fa-calendar-times fa-fw"></i> Vencimientos</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('prospectos_vista') }}"><i class="fas fa-users fa-fw"></i> Prospectos</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('siniestros_registrar') }}"><i class="fas fa-car-crash fa-fw"></i> Siniestros</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('recaudo') }}"><i class="fas fa-chart-line fa-fw"></i> Produccion</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('visualizar_sarlaft') }}"><i class="fas fa-user-shield fa-fw"></i> SARLAFT</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('mostrar_formulario_crear_carpeta') }}"><i class="fas fa-folder-plus fa-fw"></i> Crear Carpeta</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('mostrar_formulario_carga_maestra') }}"><i class="fas fa-upload fa-fw"></i> Carga Maestra</a></li>
            <li class="nav-item mt-auto"><a class="nav-link" href="{{ url_for('admin.dashboard') }}"><i class="fas fa-tachometer-alt fa-fw"></i> Admin</a></li>
        </ul>
    </div>
    <!-- Main Content -->
    <div class="content">
        <header class="pb-3 mb-4 border-bottom d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h3"><i class="fas fa-folder-plus me-2"></i>Crear Nueva Carpeta</h1>
                <p class="text-muted">Ingrese los datos para crear la estructura de carpetas.</p>
            </div>
            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary"><i class="fas fa-arrow-left"></i> Volver al Panel</a>
        </header>

        <div id="notification-container" style="display: none;"></div>

        <form method="POST" action="{{ url_for('ejecutar_crear_carpeta') }}" id="crearCarpetaForm" enctype="multipart/form-data" class="card p-4">
            <fieldset class="mb-4">
                <legend class="h5 mb-3"><i class="fas fa-folder-tree"></i> Tipo de Carpeta</legend>
                <div class="mb-3">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="tipo_carpeta" id="tipo_cliente" value="cliente" checked>
                        <label class="form-check-label" for="tipo_cliente">Cliente</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="tipo_carpeta" id="tipo_vendedor" value="vendedor">
                        <label class="form-check-label" for="tipo_vendedor">Vendedor</label>
                    </div>
                </div>
            </fieldset>

            <fieldset class="mb-4">
                <legend class="h5 mb-3"><i class="fas fa-user-tie"></i> Información</legend>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="nombre_entidad" class="form-label"><i class="fas fa-user"></i> Nombre Completo</label>
                        <input type="text" name="nombre_entidad" id="nombre_entidad" class="form-control" placeholder="Ej: Seguros Pepito S.A.S" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="nit_entidad" class="form-label"><i class="fas fa-id-card"></i> NIT o C.C.</label>
                        <input type="text" name="nit_entidad" id="nit_entidad" class="form-control" placeholder="Ej: 900123456-7" required>
                    </div>
                </div>
            </fieldset>

            <fieldset id="cliente_docs_section" class="mb-4">
                <legend class="h5 mb-3"><i class="fas fa-file-shield"></i> Documentos SARLAFT (Año: {{ ano_actual }})</legend>
                 <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="consulta_cliente" class="form-label"><i class="fas fa-landmark"></i> Consulta de cliente Desqubra</label>
                        <input type="file" name="consulta_cliente" id="consulta_cliente" class="form-control">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="doc_cedula" class="form-label"><i class="fas fa-id-badge"></i> Cédula / Rep. Legal</label>
                        <input type="file" name="doc_cedula" id="doc_cedula" class="form-control">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="doc_sarlaft" class="form-label"><i class="fas fa-file-contract"></i> Formulario SARLAFT</label>
                        <input type="file" name="doc_sarlaft" id="doc_sarlaft" class="form-control">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="doc_rut" class="form-label"><i class="fas fa-file-invoice-dollar"></i> RUT</label>
                        <input type="file" name="doc_rut" id="doc_rut" class="form-control">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="doc_declaracion" class="form-label"><i class="fas fa-file-invoice"></i> Declaración de Renta</label>
                        <input type="file" name="doc_declaracion" id="doc_declaracion" class="form-control">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="doc_camara" class="form-label"><i class="fas fa-landmark"></i> Cámara de Comercio</label>
                        <input type="file" name="doc_camara" id="doc_camara" class="form-control">
                    </div>
                </div>
                 <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="estados_financieros" class="form-label"><i class="fas fa-file-invoice-dollar"></i> Estados financieron con notas</label>
                        <input type="file" name="estados_financieros" id="estados_financieros" class="form-control">
                    </div>
                </div>
            </fieldset>

            <fieldset id="vendedor_docs_section" style="display: none;" class="mb-4">
                <legend class="h5 mb-3"><i class="fas fa-file-upload"></i> Documentos del Vendedor</legend>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label for="documentos_vendedor" class="form-label"><i class="fas fa-file-alt"></i> Contrato, Certificación, etc.</label>
                        <input type="file" name="documentos_vendedor[]" id="documentos_vendedor" class="form-control" multiple>
                    </div>
                </div>
            </fieldset>

            <div class="text-end">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Crear Estructura de Carpetas
                </button>
            </div>
        </form>
        <footer class="pt-3 mt-4 text-muted border-top">&copy; 2024 UIB Corredores de Seguros S.A.</footer>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('input[name="tipo_carpeta"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const isCliente = this.value === 'cliente';
            document.getElementById('cliente_docs_section').style.display = isCliente ? '' : 'none';
            document.getElementById('vendedor_docs_section').style.display = isCliente ? 'none' : '';
        });
    });

    function showNotification(message, type) {
        const notificationContainer = document.getElementById('notification-container');
        if (!notificationContainer) return;
        
        notificationContainer.innerHTML = '';
        const alertDiv = document.createElement('div');
        let alertClass = 'alert-info';
        if (type === 'success') alertClass = 'alert-success';
        if (type === 'error') alertClass = 'alert-danger';

        alertDiv.className = `alert ${alertClass} alert-dismissible fade show mt-3`;
        alertDiv.setAttribute('role', 'alert');
        alertDiv.textContent = message;
        
        const closeButton = document.createElement('button');
        closeButton.type = 'button';
        closeButton.className = 'btn-close';
        closeButton.setAttribute('data-bs-dismiss', 'alert');
        closeButton.setAttribute('aria-label', 'Close');
        alertDiv.appendChild(closeButton);

        notificationContainer.appendChild(alertDiv);
        notificationContainer.style.display = 'block';
    }

    document.getElementById('crearCarpetaForm').addEventListener('submit', function(event) {
        event.preventDefault();

        const btn = this.querySelector('button[type="submit"]');
        const originalBtnHTML = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creando carpetas...';

        const formData = new FormData(this);

        fetch("{{ url_for('ejecutar_crear_carpeta') }}", {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                return response.json().catch(() => {
                    throw new Error(response.statusText || `Error del servidor: ${response.status}`);
                }).then(errorData => {
                    throw new Error(errorData.message || `Error del servidor: ${response.status}`);
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
                document.getElementById('crearCarpetaForm').reset();
                document.getElementById('tipo_cliente').dispatchEvent(new Event('change'));
            } else {
                showNotification(data.message || 'Ocurrió un error.', 'error');
            }
        })
        .catch(error => {
            console.error('Error en fetch:', error);
            showNotification('Error de conexión o del servidor: ' + error.message, 'error');
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = originalBtnHTML;
        });
    });
});
</script>
</body>
</html>