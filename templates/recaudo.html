<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Producción - UIB</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='main_layout.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="main-container">
    <!-- Sidebar -->
  <div class="sidebar">
        <div class="sidebar-header">
            <a href="{{ url_for('index') }}">
                <img src="{{ url_for('static', filename='UIBH_logo_WHITE2-300x78-1.png') }}" alt="UIB Logo">
            </a>
        </div>
        <ul class="nav flex-column">
            <li class="nav-item"><a class="nav-link active" href="{{ url_for('formulario_remision') }}"><i class="fas fa-file-alt fa-fw"></i> Nueva Remisión</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('control') }}"><i class="fas fa-cogs fa-fw"></i> Control de remisiones </a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('panel_cobros') }}"><i class="fas fa-hand-holding-usd fa-fw"></i> Cobros</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('visualizar_cartera') }}"><i class="fas fa-book fa-fw"></i> Cartera</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('visualizar_vencimientos') }}"><i class="fas fa-calendar-times fa-fw"></i> Vencimientos</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('prospectos_vista') }}"><i class="fas fa-users fa-fw"></i> Prospectos</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('siniestros_registrar') }}"><i class="fas fa-car-crash fa-fw"></i> Siniestros</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('recaudo') }}"><i class="fas fa-chart-line fa-fw"></i> Produccion</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('visualizar_sarlaft') }}"><i class="fas fa-user-shield fa-fw"></i> SARLAFT</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('mostrar_formulario_crear_carpeta') }}"><i class="fas fa-folder-plus fa-fw"></i> Crear Carpeta</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('mostrar_formulario_carga_maestra') }}"><i class="fas fa-upload fa-fw"></i> Carga Maestra</a></li>
            <li class="nav-item mt-auto"><a class="nav-link" href="{{ url_for('admin.dashboard') }}"><i class="fas fa-tachometer-alt fa-fw"></i> Admin</a></li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="content">
        <header class="pb-3 mb-4 border-bottom d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h3"><i class="fas fa-hand-holding-usd me-2"></i>Panel de Producción</h1>
                <p class="text-muted">Resumen del recaudo mensual.</p>
            </div>
            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary"><i class="fas fa-arrow-left"></i> Volver al Panel</a>
        </header>

        <!-- Fila de 4 Tarjetas KPI -->
        <div class="row g-4">
            <div class="col-lg-3 col-md-6">
                <div class="card shadow-sm kpi-card" data-target="renovaciones-details" style="cursor: pointer;">
                    <div class="card-body text-center">
                        <i class="fas fa-sync-alt fa-3x text-info mb-2"></i>
                        <h5 class="card-title">Renovaciones</h5>
                        <p class="card-text fs-4 fw-bold">{{ "${:,.0f}".format(total_renovaciones) }}</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card shadow-sm kpi-card" data-target="prospectos-details" style="cursor: pointer;">
                    <div class="card-body text-center">
                        <i class="fas fa-user-plus fa-3x text-success mb-2"></i>
                        <h5 class="card-title">Negocio Nuevo</h5>
                        <p class="card-text fs-4 fw-bold">{{ "${:,.0f}".format(total_prospectos) }}</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card shadow-sm kpi-card" data-target="modificaciones-details" style="cursor: pointer;">
                    <div class="card-body text-center">
                        <i class="fas fa-pencil-alt fa-3x text-warning mb-2"></i>
                        <h5 class="card-title">Modificaciones</h5>
                        <p class="card-text fs-4 fw-bold">{{ "${:,.0f}".format(total_modificaciones) }}</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card shadow-sm bg-primary text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-dollar-sign fa-3x mb-2"></i>
                        <h5 class="card-title">Recaudo Total</h5>
                        <p class="card-text fs-4 fw-bold">{{ "${:,.0f}".format(total_general) }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenedor para las tablas de detalles -->
        <div id="details-container" class="mt-4">
            <div id="renovaciones-details" class="details-table card" style="display: none;">
                <div class="card-header"><h5>Detalle de Renovaciones</h5></div>
                <div class="card-body p-0"><div class="table-responsive"><table class="table table-striped table-hover mb-0"><thead><tr><th>Consecutivo</th><th>Tomador</th><th>Ramo</th><th>Fecha Registro</th><th>Valor UIB</th></tr></thead><tbody>
                    {% for item in renovaciones_data %}<tr><td>{{ item.consecutivo }}</td><td>{{ item.tomador }}</td><td>{{ item.ramo }}</td><td>{{ item.fecha_registro }}</td><td class="currency">{{ "${:,.0f}".format(item.uib) }}</td></tr>{% else %}<tr><td colspan="5" class="text-center p-4">No hay datos</td></tr>{% endfor %}
                </tbody></table></div></div>
            </div>
            <div id="prospectos-details" class="details-table card" style="display: none;">
                <div class="card-header"><h5>Detalle de Negocio Nuevo</h5></div>
                <div class="card-body p-0"><div class="table-responsive"><table class="table table-striped table-hover mb-0"><thead><tr><th>Consecutivo</th><th>Tomador</th><th>Ramo</th><th>Fecha Registro</th><th>Valor UIB</th></tr></thead><tbody>
                    {% for item in prospectos_data %}<tr><td>{{ item.consecutivo }}</td><td>{{ item.tomador }}</td><td>{{ item.ramo }}</td><td>{{ item.fecha_registro }}</td><td class="currency">{{ "${:,.0f}".format(item.uib) }}</td></tr>{% else %}<tr><td colspan="5" class="text-center p-4">No hay datos</td></tr>{% endfor %}
                </tbody></table></div></div>
            </div>
            <div id="modificaciones-details" class="details-table card" style="display: none;">
                <div class="card-header"><h5>Detalle de Modificaciones / Anexos</h5></div>
                <div class="card-body p-0"><div class="table-responsive"><table class="table table-striped table-hover mb-0"><thead><tr><th>Consecutivo</th><th>Tomador</th><th>Ramo</th><th>Fecha Registro</th><th>Valor UIB</th></tr></thead><tbody>
                    {% for item in modificaciones_data %}<tr><td>{{ item.consecutivo }}</td><td>{{ item.tomador }}</td><td>{{ item.ramo }}</td><td>{{ item.fecha_registro }}</td><td class="currency">{{ "${:,.0f}".format(item.uib) }}</td></tr>{% else %}<tr><td colspan="5" class="text-center p-4">No hay datos</td></tr>{% endfor %}
                </tbody></table></div></div>
            </div>
        </div>

        <!-- Fila TPP y Gráfico -->
        <div class="row g-4 mt-2">
            <div class="col-lg-4">
                <div class="card shadow-sm kpi-card h-100" data-target="tpp-details" style="cursor: pointer;">
                    <div class="card-body text-center">
                        <i class="fas fa-handshake fa-3x text-danger mb-2"></i>
                        <h5 class="card-title">Comisión TPP</h5>
                        <p class="card-text fs-4 fw-bold">{{ "${:,.0f}".format(total_tpp) }}</p>
                    </div>
                </div>
                 <div id="tpp-details" class="details-table card mt-4" style="display: none;">
                    <div class="card-header"><h5>Detalle de Comisión TPP</h5></div>
                    <div class="card-body p-0"><div class="table-responsive"><table class="table table-striped table-hover mb-0"><thead><tr><th>Consecutivo</th><th>Tomador</th><th>Ramo</th><th>Fecha Registro</th><th>Comisión TPP</th></tr></thead><tbody>
                        {% for item in tpp_data %}<tr><td>{{ item.consecutivo }}</td><td>{{ item.tomador }}</td><td>{{ item.ramo }}</td><td>{{ item.fecha_registro }}</td><td class="currency">{{ "${:,.0f}".format(item.ComisionTPP) }}</td></tr>{% else %}<tr><td colspan="5" class="text-center p-4">No hay datos</td></tr>{% endfor %}
                    </tbody></table></div></div>
                </div>
            </div>
            <div class="col-lg-8">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h5 class="card-title">Top 10 Ramos por Recaudo del Mes</h5>
                        <canvas id="ramosChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <footer class="pt-3 mt-4 text-muted border-top">&copy; 2024 UIB Corredores de Seguros S.A.</footer>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.kpi-card[data-target]').forEach(card => {
        card.addEventListener('click', function() {
            const targetId = this.dataset.target;
            const allTables = document.querySelectorAll('.details-table');
            const targetTable = document.getElementById(targetId);

            if (!targetTable) return;

            const isVisible = targetTable.style.display === 'block';

            allTables.forEach(table => {
                if (table.id !== targetId) {
                    table.style.display = 'none';
                }
            });
            
            targetTable.style.display = isVisible ? 'none' : 'block';
        });
    });

    const ctx = document.getElementById('ramosChart').getContext('2d');
    const chartData = {{ chart_data | tojson }};

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: chartData.labels,
            datasets: [{
                label: 'Comisión UIB por Ramo',
                data: chartData.data,
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) { return '$' + value.toLocaleString('es-CO'); }
                    }
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) { label += ': '; }
                            if (context.parsed.x !== null) {
                                label += '$' + context.parsed.x.toLocaleString('es-CO');
                            }
                            return label;
                        }
                    }
                }
            }
        }
    });
});
</script>
</body>
</html>