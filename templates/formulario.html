<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario Registro de Remisiones - UIB</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/static/formulario.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-file-contract"></i> Registro de Remisiones</h1>
            <p>Sistema de gestión profesional - UIB Corredor de Seguros</p>
        </div>

        <div class="form-card">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <form method="POST" action="/registrar" enctype="multipart/form-data" id="mainForm">
                <!-- Datos Básicos -->
                <fieldset>
                    <legend>
                        <div class="legend-icon"><i class="fas fa-info-circle"></i></div>
                        Datos Básicos
                    </legend>
                    <div class="form-row">
                        <div class="form-group form-group-checkbox">
                            <input type="checkbox" name="renovacion" id="renovacion" value="si">
                            <label for="renovacion"><i class="fas fa-redo"></i> Es Renovación</label>
                        </div>
                        <div class="form-group form-group-checkbox">
                            <input type="checkbox" name="negocio_nuevo" id="negocio_nuevo" value="si">
                            <label for="negocio_nuevo"><i class="fas fa-plus-circle"></i> Es Negocio Nuevo</label>
                        </div>
                        <div class="form-group form-group-checkbox">
                            <input type="checkbox" name="renovable" id="renovable" value="si">
                            <label for="renovable"><i class="fas fa-sync"></i> Es Renovable</label>
                        </div>
                        <div class="form-group form-group-checkbox">
                            <input type="checkbox" name="modificacion" id="modificacion" value="si">
                            <label for="modificacion"><i class="fas fa-edit"></i> Es Modificación</label>
                        </div>
                        <div class="form-group form-group-checkbox">
                            <input type="checkbox" name="anexo_checkbox" id="anexo_checkbox" value="si">
                            <label for="anexo_checkbox"><i class="fas fa-paperclip"></i> Es Anexo</label>
                        </div>
                    </div>
                    <!-- Section for policy number modification on renewal -->
                    <div class="form-row" id="policy-modification-section" style="display: none; background-color: #f7f7f7; padding: 1rem; border-radius: 8px; margin-top: 1rem; flex-wrap: wrap;">
                        <div class="form-group form-group-checkbox" style="width: 100%;">
                            <input type="checkbox" name="policy_number_modified" id="policy_number_modified" value="si">
                            <label for="policy_number_modified" style="font-weight: bold;"><i class="fas fa-question-circle"></i> ¿Se modificó el número de póliza en esta renovación?</label>
                        </div>
                        <div class="form-group" id="old-policy-number-section" style="display: none; width: 100%;">
                            <label for="old_policy_number"><i class="fas fa-file-alt"></i> Número de Póliza Anterior</label>
                            <input type="text" name="old_policy_number" id="old_policy_number" placeholder="Ingrese el número de póliza anterior que será actualizado a 'Renovado'">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fecha_recepcion"><i class="fas fa-calendar"></i> Fecha de Recepción</label>
                            <input type="date" name="fecha_recepcion" id="fecha_recepcion">
                        </div>
                        <div class="form-group">
                            <label for="tomador"><i class="fas fa-user"></i> Tomador</label>
                            <input type="text" name="tomador" id="tomador" placeholder="Nombre del tomador" required value="{{ prospecto.tomador if prospecto else '' }}">
                        </div>
                        <div class="form-group">
                            <label for="nit"><i class="fas fa-id-card"></i> NIT / CC</label>
                            <input type="text" name="nit" id="nit" placeholder="Número de identificación" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="aseguradora"><i class="fas fa-shield-alt"></i> Aseguradora</label>
                            <select name="aseguradora" id="aseguradora" required>
                                <option value="">Seleccione Aseguradora...</option>
                                {% for opt in opciones_aseguradora %}
                                <option value="{{ opt }}" {% if prospecto and prospecto.aseguradora == opt %}selected{% endif %}>{{ opt }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="ramo"><i class="fas fa-tags"></i> Ramo</label>
                            <select name="ramo" id="ramo" required>
                                <option value="">Seleccione Ramo...</option>
                                {% for opt in opciones_ramo %}
                                <option value="{{ opt }}" {% if prospecto and prospecto.ramo == opt %}selected{% endif %}>{{ opt }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="poliza"><i class="fas fa-file-alt"></i> N° Póliza</label>
                            <input type="text" name="poliza" id="poliza" placeholder="Número de póliza" required value="{{ prospecto.poliza if prospecto else '' }}">
                        </div>
                        <div class="form-group">
                            <label for="anexo"><i class="fas fa-paperclip"></i> Anexo / Certificado</label>
                            <input type="text" name="anexo" id="anexo" placeholder="Número de anexo">
                        </div>
                        <div class="form-group">
                            <label for="categorias_grupo"><i class="fas fa-tags"></i> Categorías / Grupo</label>
                            <select name="categorias_grupo" id="categorias_grupo">
                                <option value="">Seleccione un grupo...</option>
                                <option value="Grupo Cartagena">Grupo Cartagena</option>
                                <option value="Grupo Tenco">Grupo Tenco</option>
                                <option value="Otro">Otro</option>
                            </select>
                            <input type="text" name="categorias_grupo_otro" id="categorias_grupo_otro" placeholder="Especifique otro grupo" style="display:none; margin-top: 1rem;">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fecha_inicio"><i class="fas fa-calendar-play"></i> Fecha Inicio Vigencia</label>
                            <input type="date" name="fecha_inicio" id="fecha_inicio" required>
                        </div>
                        <div class="form-group">
                            <label for="fecha_fin"><i class="fas fa-calendar-times"></i> Fecha Fin Vigencia</label>
                            <input type="date" name="fecha_fin" id="fecha_fin" required>
                        </div>
                        <div class="form-group">
                            <label for="fecha_limite_pago"><i class="fas fa-exclamation-triangle"></i> Fecha Límite de Pago</label>
                            <input type="date" name="fecha_limite_pago" id="fecha_limite_pago">
                        </div>
                    </div>
                </fieldset>

                <!-- Información de Venta -->
                <fieldset>
                    <legend>
                        <div class="legend-icon"><i class="fas fa-chart-line"></i></div>
                        Información de Venta y Comisiones
                    </legend>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="tipo_moneda"><i class="fas fa-coins"></i> Tipo Moneda</label>
                            <select name="tipo_moneda" id="tipo_moneda" required>
                                <option value="">Seleccione Moneda...</option>
                                {% for opt in opciones_tipo_moneda %}
                                <option value="{{ opt }}">{{ opt }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="prima_neta"><i class="fas fa-money-bill-wave"></i> Prima Neta</label>
                            <input type="text" name="prima_neta" id="prima_neta" class="currency" placeholder="0" required value="{{ prospecto.prima_neta if prospecto else '' }}">
                        </div>
                        <div class="form-group">
                            <label for="gastos_adicionales"><i class="fas fa-receipt"></i> Gastos Adicionales</label>
                            <input type="text" name="gastos_adicionales" id="gastos_adicionales" class="currency" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label for="porcentaje_comision_valor"><i class="fas fa-percentage"></i> % Comisión</label>
                            <input type="number" name="porcentaje_comision_valor" id="porcentaje_comision_valor" placeholder="0.00" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="comision_calculada"><i class="fas fa-dollar-sign"></i> Comision$</label>
                            <input type="text" name="Comision$" id="comision_calculada" class="currency" placeholder="0" readonly>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="vendedor"><i class="fas fa-user-tie"></i> Vendedor</label>
                             <select name="vendedor" id="vendedor" required>
                                <option value="">Seleccione Vendedor...</option>
                                {% for vendedor in opciones_vendedor %}
                                <option value="{{ vendedor.nombre }}" data-comision="{{ vendedor.comision }}">{{ vendedor.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="porcentaje_vendedor"><i class="fas fa-percentage"></i> % Participación Vendedor</label>
                            <input type="number" name="porcentaje_vendedor" id="porcentaje_vendedor" placeholder="0.00" step="0.01">
                        </div>
                        <div class="form-group">
                            <label for="co_corretaje_opcion"><i class="fas fa-handshake"></i> Aplica Co-corretaje</label>
                            <select name="co_corretaje_opcion" id="co_corretaje_opcion">
                                <option value="no" selected>No</option>
                                <option value="si">Sí</option>
                            </select>
                        </div>
                         <div class="form-group" id="co-corretaje-details" style="display: none;">
                            <label for="co_corretaje_nombre"><i class="fas fa-user-friends"></i> Nombre Co-corredor</label>
                            <input type="text" name="co_corretaje_nombre" id="co_corretaje_nombre" placeholder="Nombre del co-corredor">
                            <label for="co_corretaje_porcentaje" style="margin-top: 1rem;"><i class="fas fa-percentage"></i> % Co-corretaje</label>
                            <input type="number" name="co_corretaje_porcentaje" id="co_corretaje_porcentaje" step="0.01" placeholder="0.00">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="comision_tpp"><i class="fas fa-hand-holding-usd"></i> ComisionTPP</label>
                            <input type="text" name="ComisionTPP" id="comision_tpp" class="currency" placeholder="0" readonly>
                        </div>
                        <div class="form-group">
                            <label for="uib"><i class="fas fa-building"></i> ComisionUIB</label>
                            <input type="text" name="uib" id="uib" placeholder="0" class="currency" readonly>
                        </div>
                    </div>
                </fieldset>

                <!-- Informacion del pago -->
                <fieldset>
                    <legend>
                        <div class="legend-icon"><i class="fas fa-credit-card"></i></div>
                        Informacion del pago
                    </legend>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="periodicidad_pago"><i class="fas fa-repeat"></i> Periodicidad de Pago</label>
                            <select name="periodicidad_pago" id="periodicidad_pago" required>
                                <option value="">Seleccione Periodicidad...</option>
                                {% for opt in opciones_periodicidad_pago %}
                                <option value="{{ opt }}">{{ opt }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="forma_pago"><i class="fas fa-credit-card"></i> Forma de Pago</label>
                            <select name="forma_pago" id="forma_pago" required>
                                <option value="">Seleccione Forma de Pago...</option>
                                {% for opt in opciones_forma_pago %}
                                <option value="{{ opt }}">{{ opt }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group" id="numero_cuotas_group" style="display: none;">
                            <label for="numero_cuotas"><i class="fas fa-list-ol"></i> # de Cuotas</label>
                            <input type="number" id="numero_cuotas" name="numero_cuotas" min="0" max="12" step="1" placeholder="0-12">
                        </div>
                        <div class="form-group" id="tipo_movimiento_group" style="display: none;">
                            <label for="tipo_movimiento"><i class="fas fa-exchange-alt"></i> Tipo de Movimiento</label>
                            <select id="tipo_movimiento" name="tipo_movimiento">
                                <option value="Cobro mensual">Cobro mensual</option>
                                <option value="Pago mensual">Pago mensual</option>
                            </select>
                        </div>
                    </div>
                </fieldset>

                <!-- Valores y Observaciones --> 
                <fieldset>
                    <legend>
                        <div class="legend-icon"><i class="far fa-file-alt"></i></div>
                        Observaciones
                    </legend>
                    <div class="form-group">
                        <label for="observaciones"><i class="fas fa-sticky-note"></i> Observaciones</label>
                        <textarea name="observaciones" id="observaciones" rows="4" placeholder="Escriba aquí cualquier observación adicional..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="riesgos_adicionales"><i class="fas fa-exclamation-triangle"></i> Riesgos Adicionales</label>
                        <textarea name="riesgos_adicionales" id="riesgos_adicionales" rows="3" placeholder="Describa riesgos adicionales..."></textarea>
                    </div>
                    <div class="form-group">
                            <label for="analista_responsable"><i class="fas fa-user"></i> Analista Responsable </label>
                            <select name="analista_responsable" id="analista_responsable" required>
                                <option value="">Seleccione el Analista.</option>
                                {% for opt in opciones_analista %}
                                <option value="{{ opt }}">{{ opt }}</option>
                                {% endfor %}
                            </select>
                    </div>


                </fieldset>

                <!-- Carga de archivos -->
                <fieldset>
                    <legend>
                        <div class="legend-icon"><i class="fas fa-cloud-upload-alt"></i></div>
                        Cargar Archivos
                    </legend>
                    <div id="file-container">
                        <div class="archivo-group">
                            <div class="file-input-wrapper">
                                <input type="file" name="archivos[]" id="file-1" required>
                                <label for="file-1" class="file-input-label">
                                    <i class="fas fa-upload"></i>
                                    Seleccionar archivo
                                </label>
                            </div>
                            <select name="tipo_archivo[]" onchange="handleTipoArchivoChange(this)">
                                <option value="Recibo">RECIBO</option>
                                <option value="Poliza">PÓLIZA</option>
                                <option value="Clausulado">CLAUSULADO</option>
                                <option value="Otro">Otro</option>
                            </select>
                            <input type="text" name="otro_tipo_nombre[]" class="otro-tipo-nombre-input" placeholder="Especifique nombre para 'Otro'" style="display:none; width: 100%; margin-top: 0.5rem; padding: 0.9rem; border: 2px solid var(--border-color); border-radius: 12px;">
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary btn-add" onclick="agregarArchivo()">
                        <i class="fas fa-plus"></i>
                        Añadir otro archivo
                    </button>
                </fieldset>

                <div class="form-actions">
                    <button type="submit" class="btn btn-submit">
                        <i class="fas fa-save"></i>
                        Guardar Remisión
                    </button>
                </div>
                 <div class="form-actions" style="margin-top: 1rem;"> <!-- Adjusted margin for spacing -->
                    <a href="{{ url_for('index') }}" class="btn btn-secondary" style="text-align: center;">
                        <i class="fas fa-arrow-left"></i> Volver al Panel Principal
                    </a>
                    <a href="{{ url_for('control') }}" class="btn btn-secondary" style="text-align: center;">
                        <i class="fas fa-list-alt"></i>
                        Ver Remisiones Registradas
                    </a>
                </div>
            </form>
        </div>
    </div>

    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        Formulario enviado correctamente
    </div>

    <!-- Modal para Grupo Cartagena -->
    <div id="cartagenaModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <p>Recuerda que este grupo tiene Co-corretaje, recuerda ingresar los valores y las comisiones correctas.</p>
            <button id="modalAceptarBtn" class="btn">Aceptar</button>
        </div>
    </div>

    <script>
        let fileCounter = 1;

        function handleTipoArchivoChange(selectElement) {
            const archivoGroup = selectElement.closest('.archivo-group');
            if (!archivoGroup) return; 
            const otroNombreInput = archivoGroup.querySelector('.otro-tipo-nombre-input');
            if (!otroNombreInput) return; 

            if (selectElement.value === 'Otro') {
                otroNombreInput.style.display = 'block';
                otroNombreInput.required = true;
            } else {
                otroNombreInput.style.display = 'none';
                otroNombreInput.value = ''; 
                otroNombreInput.required = false;
            }
        }

        // Agregar archivos dinámicamente
        function agregarArchivo() {
            fileCounter++;
            const container = document.getElementById('file-container');
            const nuevo = document.createElement('div');
            nuevo.className = 'archivo-group';
            nuevo.innerHTML = `
                <div class="file-input-wrapper">
                    <input type="file" name="archivos[]" id="file-${fileCounter}" required>
                    <label for="file-${fileCounter}" class="file-input-label">
                        <i class="fas fa-upload"></i>
                        Seleccionar archivo
                    </label>
                </div>
                <select name="tipo_archivo[]" onchange="handleTipoArchivoChange(this)">
                    <option value="Recibo">Recibo</option>
                    <option value="Poliza">Póliza</option>
                    <option value="Clausulado">Clausulado</option>
                    <option value="Otro">Otro</option>
                </select>
                <input type="text" name="otro_tipo_nombre[]" class="otro-tipo-nombre-input" placeholder="Especifique nombre para 'Otro'" style="display:none; width: 100%; margin-top: 0.5rem; padding: 0.9rem; border: 2px solid var(--border-color); border-radius: 12px;">
                <button type="button" class="btn" onclick="eliminarArchivo(this)" style="background: var(--error-color); padding: 0.75rem;">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            container.appendChild(nuevo);
            
            // Añadir efecto de aparición
            nuevo.style.opacity = '0';
            nuevo.style.transform = 'translateY(20px)';
            setTimeout(() => {
                nuevo.style.transition = 'all 0.3s ease';
                nuevo.style.opacity = '1';
                nuevo.style.transform = 'translateY(0)';
            }, 100);
        }

        function eliminarArchivo(button) {
            const archivoGroup = button.parentElement;
            archivoGroup.style.transition = 'all 0.3s ease';
            archivoGroup.style.opacity = '0';
            archivoGroup.style.transform = 'translateY(-20px)';
            setTimeout(() => {
                archivoGroup.remove();
            }, 300);
        }

        function formatAsInteger(input) {
            let value = input.value.replace(/[^0-9]/g, '');
            if (value) {
                input.value = '$' + parseInt(value, 10).toLocaleString('es-CO');
            } else {
                input.value = '';
            }
        }

        // Actualizar etiquetas de archivos
        function updateFileLabel(input) {
            const label = input.nextElementSibling;
            if (input.files.length > 0) {
                label.innerHTML = `<i class="fas fa-check-circle" style="color: var(--success-color);"></i> ${input.files[0].name}`;
                label.style.background = 'rgba(16, 185, 129, 0.1)';
                label.style.borderColor = 'var(--success-color)';
            }
        }

        // Barra de progreso
        function updateProgress() {
            const form = document.getElementById('mainForm');
            const inputs = form.querySelectorAll('input[required], select[required], textarea[required]');
            let filled = 0;

            inputs.forEach(input => {
                if (input.type === 'file') {
                    if (input.files.length > 0) filled++;
                } else if (input.value.trim() !== '') {
                    filled++;
                }
            });

            const progress = (filled / inputs.length) * 100;
            document.getElementById('progressFill').style.width = `${progress}%`;
        }

        // Mostrar notificación
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification show ${type}`;

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize "Otro" input visibility for existing select fields
            document.querySelectorAll('select[name="tipo_archivo[]"]').forEach(selectEl => {
                handleTipoArchivoChange(selectEl);
            });

            // --- Logic for Policy Number Modification on Renewal ---
            const renovacionCheckbox = document.getElementById('renovacion');
            const policyModificationSection = document.getElementById('policy-modification-section');
            const policyNumberModifiedCheckbox = document.getElementById('policy_number_modified');
            const oldPolicyNumberSection = document.getElementById('old-policy-number-section');
            const oldPolicyNumberInput = document.getElementById('old_policy_number');

            if (renovacionCheckbox) {
                renovacionCheckbox.addEventListener('change', function() {
                    policyModificationSection.style.display = this.checked ? 'flex' : 'none';
                    if (!this.checked) {
                        policyNumberModifiedCheckbox.checked = false;
                        oldPolicyNumberSection.style.display = 'none';
                        oldPolicyNumberInput.value = '';
                        oldPolicyNumberInput.required = false;
                    }
                });
            }

            if (policyNumberModifiedCheckbox) {
                policyNumberModifiedCheckbox.addEventListener('change', function() {
                    oldPolicyNumberSection.style.display = this.checked ? 'block' : 'none';
                    oldPolicyNumberInput.required = this.checked;
                    if (!this.checked) {
                        oldPolicyNumberInput.value = '';
                    }
                });
            }

            // --- Lógica de Cálculo y Formato de Moneda ---
            const primaNetaInput = document.getElementById('prima_neta');
            const porcComisionInput = document.getElementById('porcentaje_comision_valor');
            const comisionCalculadaInput = document.getElementById('comision_calculada');
            const coCorretajeSelect = document.getElementById('co_corretaje_opcion');
            const coCorretajeDetails = document.getElementById('co-corretaje-details');
            const porcCoCorretajeInput = document.getElementById('co_corretaje_porcentaje');
            const comisionTppInput = document.getElementById('comision_tpp');
            const participacionUibInput = document.getElementById('uib');

            function calcularComisiones() {
                const primaNeta = parseFloat(primaNetaInput.value.replace(/\$|\./g, '').replace(',', '.')) || 0;
                const porcComision = parseFloat(porcComisionInput.value) || 0;
                const porcCoCorretaje = parseFloat(porcCoCorretajeInput.value) || 0;

                const comisionTotal = primaNeta * (porcComision / 100);
                comisionCalculadaInput.value = '$' + Math.round(comisionTotal).toLocaleString('es-CO');

                let comisionTpp = 0;
                if (coCorretajeSelect.value === 'si' && porcCoCorretaje > 0) {
                    comisionTpp = comisionTotal * (porcCoCorretaje / 100);
                }

                comisionTppInput.value = '$' + Math.round(comisionTpp).toLocaleString('es-CO');
                const comisionUib = comisionTotal - comisionTpp;
                participacionUibInput.value = '$' + Math.round(comisionUib).toLocaleString('es-CO');
            }

            [primaNetaInput, porcComisionInput, porcCoCorretajeInput, coCorretajeSelect].forEach(input => {
                if(input) input.addEventListener('input', calcularComisiones);
            });

            if (coCorretajeSelect) {
                coCorretajeSelect.addEventListener('change', function() {
                    coCorretajeDetails.style.display = this.value === 'si' ? 'block' : 'none';
                    if (this.value !== 'si') {
                        porcCoCorretajeInput.value = '';
                    }
                    calcularComisiones();
                });
            }

            // Formatear todos los campos de moneda como enteros
            document.querySelectorAll('input.currency').forEach(input => {
                if (!input.readOnly) {
                    input.addEventListener('input', () => formatAsInteger(input));
                    input.addEventListener('blur', () => formatAsInteger(input));
                }
            });

            // Actualizar etiquetas de archivos
            document.addEventListener('change', function(e) {
                if (e.target.type === 'file') {
                    updateFileLabel(e.target);
                    updateProgress();
                }
            });

            // Actualizar progreso en tiempo real
            document.getElementById('mainForm').addEventListener('input', updateProgress);

            // Validación del formulario
            document.getElementById('mainForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const submitBtn = this.querySelector('.btn-submit');
                const originalText = submitBtn.innerHTML;

                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
                submitBtn.disabled = true;
                
                const formData = new FormData(this);

                fetch("{{ url_for('registrar') }}", {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = `/resumen/${data.consecutivo}`;
                    } else {
                        showNotification(data.message || 'Error al guardar.', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('Error de conexión.', 'error');
                })
                .finally(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                });
            });

            // --- Lógica de Visibilidad para # de Cuotas ---
            const periodicidadSelect = document.getElementById('periodicidad_pago');
            const formaPagoSelect = document.getElementById('forma_pago');
            const cuotasGroup = document.getElementById('numero_cuotas_group');
            const tipoMovimientoGroup = document.getElementById('tipo_movimiento_group');

            function toggleCuotasField() {
                const esMensual = periodicidadSelect.value === 'Mensual';
                const esContado = formaPagoSelect.value === 'Contado';
                const show = esMensual && !esContado;

                cuotasGroup.style.display = show ? 'block' : 'none';
                cuotasGroup.querySelector('input').required = show;
                tipoMovimientoGroup.style.display = show ? 'block' : 'none';
                tipoMovimientoGroup.querySelector('select').required = show;
            }

            if(periodicidadSelect) periodicidadSelect.addEventListener('change', toggleCuotasField);
            if(formaPagoSelect) formaPagoSelect.addEventListener('change', toggleCuotasField);
            toggleCuotasField();

            // --- Lógica para Categorías / Grupo ---
            const categoriasSelect = document.getElementById('categorias_grupo');
            const otroGrupoInput = document.getElementById('categorias_grupo_otro');
            const cartagenaModal = document.getElementById('cartagenaModal');
            const modalAceptarBtn = document.getElementById('modalAceptarBtn');

            if (categoriasSelect) {
                categoriasSelect.addEventListener('change', function() {
                    otroGrupoInput.style.display = this.value === 'Otro' ? 'block' : 'none';
                    otroGrupoInput.required = this.value === 'Otro';
                    if (this.value === 'Grupo Cartagena') {
                        cartagenaModal.style.display = 'flex';
                    }
                });
            }

            if (modalAceptarBtn) {
                modalAceptarBtn.addEventListener('click', () => cartagenaModal.style.display = 'none');
            }
            if (cartagenaModal) {
                cartagenaModal.addEventListener('click', (e) => {
                    if (e.target === cartagenaModal) cartagenaModal.style.display = 'none';
                });
            }

            // --- Lógica para autocompletar comisión de vendedor ---
            const vendedorSelect = document.getElementById('vendedor');
            const porcComisionInput = document.getElementById('porcentaje_comision_valor');

            if (vendedorSelect && porcComisionInput) {
                vendedorSelect.addEventListener('change', function() {
                    const selectedOption = this.options[this.selectedIndex];
                    const comision = selectedOption.dataset.comision;

                    porcComisionInput.value = comision || '';
                    porcComisionInput.dispatchEvent(new Event('input'));
                });
            }

            // Inicializar
            updateProgress();

            // Set default date for fecha_recepcion
            const fechaRecepcion = document.getElementById('fecha_recepcion');
            if (fechaRecepcion && !fechaRecepcion.value) {
                fechaRecepcion.value = new Date().toISOString().split('T')[0];
            }
        });
    </script>
</body>
</html>
