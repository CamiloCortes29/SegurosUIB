<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Editar Lista: {{ list_name|title }}</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        body { font-family: sans-serif; margin: 2em; background-color: #f4f4f9; }
        .container { max-width: 700px; margin: auto; background: white; padding: 2em; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .list-item:last-child { border-bottom: none; }
        .item-text { flex-grow: 1; }
        .actions button { background: none; border: none; cursor: pointer; font-size: 1.1em; margin-left: 10px; }
        .btn-edit { color: #007bff; }
        .btn-delete { color: #dc3545; }
        .form-add { display: flex; margin-top: 1.5em; }
        .form-add input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        .form-add button { padding: 10px 15px; background-color: #28a745; color: white; border: none; border-radius: 4px; margin-left: 10px; cursor: pointer; }
        .notification { padding: 1em; margin-top: 1em; border-radius: 4px; display: none; }
        .notification.success { background-color: #d4edda; color: #155724; }
        .notification.error { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <a href="{{ url_for('admin_listas') }}">&larr; Volver a todas las listas</a>
        <h1>Editando: {{ list_name.replace('_', ' ')|title }}</h1>

        <div id="item-list">
            <!-- Los items se cargarán aquí con JS -->
        </div>

        <div class="form-add">
            <input type="text" id="new-item-input" placeholder="Añadir nuevo elemento...">
            <button id="add-item-btn"><i class="fas fa-plus"></i> Añadir</button>
        </div>

        <button id="save-changes-btn" style="width: 100%; padding: 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; margin-top: 20px; font-size: 1.2em; cursor: pointer;">
            <i class="fas fa-save"></i> Guardar Cambios
        </button>

        <div id="notification" class="notification"></div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const listName = '{{ list_name }}';
    let items = {{ items|tojson }};

    const itemList = document.getElementById('item-list');
    const newItemInput = document.getElementById('new-item-input');
    const addItemBtn = document.getElementById('add-item-btn');
    const saveChangesBtn = document.getElementById('save-changes-btn');
    const notification = document.getElementById('notification');

    function renderItems() {
        itemList.innerHTML = '';
        if (items.length === 0) {
            itemList.innerHTML = '<p>No hay elementos en esta lista.</p>';
            return;
        }
        items.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'list-item';
            div.innerHTML = `
                <span class="item-text">${escapeHTML(item)}</span>
                <div class="actions">
                    <button class="btn-edit" data-index="${index}"><i class="fas fa-edit"></i></button>
                    <button class="btn-delete" data-index="${index}"><i class="fas fa-trash-alt"></i></button>
                </div>
            `;
            itemList.appendChild(div);
        });
    }

    function handleAddItem() {
        const value = newItemInput.value.trim();
        if (value) {
            if (items.includes(value)) {
                showNotification('El elemento ya existe.', 'error');
                return;
            }
            items.push(value);
            newItemInput.value = '';
            renderItems();
            showNotification('Elemento añadido. No olvides guardar los cambios.', 'success');
        }
    }

    function handleEditItem(index) {
        const current_value = items[index];
        const new_value = prompt('Editar elemento:', current_value);
        if (new_value && new_value.trim() !== '' && new_value !== current_value) {
            if (items.includes(new_value.trim())) {
                showNotification('El elemento ya existe.', 'error');
                return;
            }
            items[index] = new_value.trim();
            renderItems();
        }
    }

    function handleDeleteItem(index) {
        if (confirm(`¿Estás seguro de que quieres eliminar "${items[index]}"?`)) {
            items.splice(index, 1);
            renderItems();
        }
    }

    async function handleSaveChanges() {
        saveChangesBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
        saveChangesBtn.disabled = true;

        try {
            const response = await fetch(`/api/listas/${listName}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(items),
            });
            const result = await response.json();
            if (result.success) {
                showNotification('¡Lista guardada exitosamente!', 'success');
            } else {
                showNotification(`Error: ${result.message}`, 'error');
            }
        } catch (error) {
            showNotification(`Error de red: ${error}`, 'error');
        } finally {
            saveChangesBtn.innerHTML = '<i class="fas fa-save"></i> Guardar Cambios';
            saveChangesBtn.disabled = false;
        }
    }

    function showNotification(message, type) {
        notification.textContent = message;
        notification.className = `notification ${type}`;
        notification.style.display = 'block';
        setTimeout(() => {
            notification.style.display = 'none';
        }, 4000);
    }

    function escapeHTML(str) {
        const div = document.createElement('div');
        div.appendChild(document.createTextNode(str));
        return div.innerHTML;
    }

    // Event Listeners
    addItemBtn.addEventListener('click', handleAddItem);
    newItemInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            handleAddItem();
        }
    });

    saveChangesBtn.addEventListener('click', handleSaveChanges);

    itemList.addEventListener('click', function(e) {
        const button = e.target.closest('button');
        if (!button) return;

        const index = parseInt(button.dataset.index, 10);
        if (button.classList.contains('btn-edit')) {
            handleEditItem(index);
        } else if (button.classList.contains('btn-delete')) {
            handleDeleteItem(index);
        }
    });

    // Initial render
    renderItems();
});
</script>
</body>
</html>
